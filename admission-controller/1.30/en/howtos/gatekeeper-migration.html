<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Migrating Gatekeeper Policies to SUSE Security Admission Controller :: Rancher product documentation</title>
    <link rel="canonical" href="https://documentation.suse.com/cloudnative/admission-controller/1.29/en/howtos/gatekeeper-migration.html">
    <link rel="prev" href="contribution-guide/suggesting-an-improvement.html">
    <link rel="next" href="../reference/CRDs.html">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../../_/css/site.css">
<meta http-equiv="last-modified" content="2025-07-09"/>
<link rel="stylesheet" href="../../../../_/css/search.css">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="../../../../_/css/font-styles.css">
<link rel="stylesheet" href="../../../../_/fonts/css/all.css">
<link rel="stylesheet" href="../../../../_/css/site-extra.css">
<link rel="stylesheet" href="../../../../_/css/vendor/tabs.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=SUSE:wght@100..800&display=swap&family=SUSE+Mono:ital,wght@0,100..800;1,100..800" rel="stylesheet">
<link href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css" rel="stylesheet">
<!-- <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto&display=swap" rel="stylesheet"> -->
<link rel="stylesheet" href="../../../../_/css/vendor/light.css">
<script src="/docserv/res/lightheaded/analytics.js" type="text/javascript"></script>

<script type="module">
  import { defineCustomElements, setAssetPath } from 'https://d12w0ryu9hjsx8.cloudfront.net/shared-header/1.5/shared-header.esm.js';
  defineCustomElements();
  setAssetPath("https://d12w0ryu9hjsx8.cloudfront.net/shared-header/1.5/assets");
</script>    <script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<script type="module">import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs'; mermaid.initialize({"startOnLoad":true});</script><!-- Canonical link -->
<link href="https://documentation.suse.com/cloudnative/admission-controller/1.29/en/howtos/gatekeeper-migration.html" rel="canonical"/>

<!-- Default English link -->
<link href="https://documentation.suse.com/cloudnative/admission-controller/1.30/en/howtos/gatekeeper-migration.html" hreflang="x-default" rel="alternate"/>

<!-- Link for the currently processed page -->
<link href="https://documentation.suse.com/cloudnative/admission-controller/1.30/en/howtos/gatekeeper-migration.html" hrefLang="en-US" rel="alternate" />











<shared-header language="en" languages='{
"en": { "label": "English", "url": "https://documentation.suse.com/en-us/" },
"de": { "label": "Deutsch", "url": "https://documentation.suse.com/de-de/" },
"fr": { "label": "Français", "url": "https://documentation.suse.com/fr-fr/" },
"es": { "label": "Español", "url": "https://documentation.suse.com/es-es/" },
"zh_CN": { "label": "中文", "url": "https://documentation.suse.com/zh-cn/" },
"pt_BR": { "label": "Português Brasileiro", "url": "https://documentation.suse.com/pt-br/" }
}'>
</shared-header>

<!-- Leaving as a comment, I expect it will be required again next year.
<a target=_blank"" class="survey-link" href="https://suselinux.fra1.qualtrics.com/jfe/form/SV_bEiGZbUNzLD8Tcy"> Documentation survey </a>
--><div class="body">
<div class="nav-container" data-component="admission-controller" data-version="1.30">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title">Admission Controller</h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../introduction.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../quick-start.html">Quick start</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Tutorials</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../tutorials/writing-policies/index.html">Writing SUSE Security Admission Controller policies</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../tutorials/writing-policies/CEL/01-intro-cel.html">Introduction to CEL</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/CEL/02-reusing-vap.html">Reusing ValidatingAdmissionPolicies</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/CEL/03-context-aware.html">Context-aware CEL policies</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/CEL/04-example-sigstore.html">Sigstore host capabilities</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../tutorials/writing-policies/rust/01-intro-rust.html">Rust</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/rust/02-create-policy.html">Creating a policy</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/rust/03-define-policy-settings.html">Defining policy settings</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/rust/04-write-validation-logic.html">Writing validation logic</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/rust/05-mutation-policy.html">Creating a new mutation policy</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/rust/06-logging.html">Logging</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/rust/07-build-and-distribute.html">Building and distributing policies</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/rust/08-raw-policies.html">Raw policies</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../tutorials/writing-policies/go/01-intro-go.html">Writing policies in Go</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/go/02-scaffold.html">Creating a new validation policy</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/go/03-policy-settings.html">Defining policy settings</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/go/04-validation.html">Writing the validation logic</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/go/05-e2e-tests.html">End-to-end testing</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/go/06-logging.html">Logging</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/go/07-automate.html">Integrating with GitHub Actions</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/go/08-distribute.html">Distributing policy</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/go/09-validation-with-queries.html">Validation using JSON queries</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/go/10-raw-policies.html">Writing raw policies</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../tutorials/writing-policies/rego/01-intro-rego.html">Rego</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/rego/02-builtin-support.html">Builtin support</a>
  </li>
  <li class="nav-item" data-depth="4">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Open Policy Agent</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../tutorials/writing-policies/rego/open-policy-agent/01-intro.html">Introduction to Open Policy Agent</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../tutorials/writing-policies/rego/open-policy-agent/02-create-policy.html">Creating a new policy</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../tutorials/writing-policies/rego/open-policy-agent/03-build-and-run.html">Build and run a OPA policy for Admission Controller</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../tutorials/writing-policies/rego/open-policy-agent/04-distribute.html">Distributing an OPA policy with SUSE Security Admission Controller</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../tutorials/writing-policies/rego/open-policy-agent/05-raw-policies.html">Writing raw policies</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="4">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Gatekeeper</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../tutorials/writing-policies/rego/gatekeeper/01-intro.html">Gatekeeper support</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../tutorials/writing-policies/rego/gatekeeper/02-create-policy.html">Creating a new Gatekeeper Rego policy</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../tutorials/writing-policies/rego/gatekeeper/03-build-and-run.html">Build and run a Gatekeeper policy</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../tutorials/writing-policies/rego/gatekeeper/04-distribute.html">Distributing a Gatekeeper policy with SUSE Security Admission Controller</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../tutorials/writing-policies/dotnet.html">C#</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../tutorials/writing-policies/swift.html">Swift</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../tutorials/writing-policies/typescript.html">Typescript</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../tutorials/writing-policies/other-languages.html">Other languages</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">WASI</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/wasi/01-intro-wasi.html">WASI</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../tutorials/writing-policies/wasi/02-raw-policies.html">Writing raw policies</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../tutorials/writing-policies/metadata.html">Policy metadata</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Testing policies</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../tutorials/testing-policies/index.html">Policy testing</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../tutorials/testing-policies/02-policy-authors.html">Testing for policy authors</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../tutorials/testing-policies/03-cluster-operators.html">Testing for cluster operators</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tutorials/verifying-kubewarden.html">Verifying SUSE Security Admission Controller</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tutorials/publish-policy-to-artifact-hub.html">Publish policies to Artifact Hub</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Explanations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../explanations/mutating-policies.html">Mutating policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../explanations/context-aware-policies.html">Context aware policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../explanations/policy-groups.html">Policy Groups</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../explanations/certificates.html">Certificate rotation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../explanations/distributing-policies.html">Distributing policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Comparisons</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../explanations/comparisons/opa-comparison.html">SUSE Security Admission Controller vs OPA Gatekeeper</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../explanations/audit-scanner/audit-scanner.html">What is the Audit Scanner?</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../explanations/audit-scanner/limitations.html">Audit Scanner - Limitations</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../explanations/audit-scanner/policy-reports.html">Audit Scanner - Policy Reports</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../explanations/architecture.html">Admission Controller architecture</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Howtos</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tasks.html">Common tasks</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="install-kwctl.html">Install <code>kwctl</code></a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="production-deployments.html">Production deployments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="deploy-at-scale.html">Deployment at scale</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="audit-scanner.html">Audit Scanner</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="policies.html">Configuring policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="emergency-disable.html">Emergency disable</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Configuring Policy Servers</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="policy-servers/01-custom-cas.html">Using custom CAs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="policy-servers/02-private-registry.html">Configuring PolicyServers to use private registries</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="policy-servers/03-production-deployments.html">Production deployments</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="policy-groups.html">Policy groups</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="psp-migration.html">PSP migration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="vap-migration.html">ValidatingAdmissionPolicy migration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pod-security-admission-with-kubewarden.html">Pod Security Admission</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="custom-certificate-authorities.html">Custom certificate authorities</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="raw-policies.html">Raw policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="argocd-installation.html">ArgoCD Installation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="security-hardening/security-hardening.html">Security</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="security-hardening/secure-supply-chain.html">Secure supply chain</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="security-hardening/webhook-mtls.html">Enable mTLS with K3s</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Air gap</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="airgap/01-requirements.html">Requirements</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="airgap/02-install.html">Installation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="airgap/03-hauler.html">Hauler installation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Telemetry quick starts</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="telemetry/10-opentelemetry-qs.html">Open Telemetry quick start</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="telemetry/20-tracing-qs.html">Tracing quickstart</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="telemetry/30-metrics-qs.html">Metrics quickstart</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="telemetry/40-custom-otel-collector.html">Custom OpenTelemetry Collector</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="Rancher-Fleet.html">Rancher Fleet</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Rancher UI extension</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ui-extension/01-install.html">Quickstart</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ui-extension/02-metrics.html">Monitoring</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ui-extension/03-tracing.html">Tracing</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Rancher Application Collection</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="application-collection/01-verify-images.html">Verify images</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Workarounds</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="workarounds/policy-server-certificate-expiry.html">Certificate rotation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="contribution-guide/contribution-guide.html">Contribution guide</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="contribution-guide/contributing.html">Contributing to documentation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="contribution-guide/suggesting-an-improvement.html">Improving documentation</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="gatekeeper-migration.html">Migrating Gatekeeper Policies to SUSE Security Admission Controller</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Reference</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/CRDs.html">Custom Resource Definitions (CRD)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/dependency-matrix.html">Dependency matrix</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/artifacts.html">Artifacts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/upgrade-path.html">Upgrade path</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/metrics-reference.html">Metrics reference</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/monitor-mode.html">Monitor mode</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Policy specification</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../reference/spec/01-intro-spec.html">Policy communication specification</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../reference/spec/02-settings.html">Policy settings</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../reference/spec/03-validating-policies.html">Validating policies</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../reference/spec/04-mutating-policies.html">Mutating policies</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../reference/spec/05-context-aware-policies.html">Context aware policies</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Host capabilities</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../reference/spec/host-capabilities/01-intro-host-capabilities.html">Host capabilities specification</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../reference/spec/host-capabilities/02-signature-verifier-policies.html">Signature verifier policies</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../reference/spec/host-capabilities/03-container-registry.html">Container registry capabilities</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../reference/spec/host-capabilities/04-net.html">Network capabilities</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../reference/spec/host-capabilities/05-crypto.html">Cryptographic capabilities</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../reference/spec/host-capabilities/06-kubernetes.html">Kubernetes capabilities</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/oci-registries-support.html">OCI registry support for Admission Controller</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Security</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../reference/security-hardening/webhooks-hardening.html">Webhooks</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/threat-model.html">Threat Model</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/policy-evaluation-timeout.html">Policy evaluation timeout protection</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/verification-config.html">Verification configuration format</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/sources_yaml.html">Reference for sources.yaml</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/kwctl-cli.html"><code>kwctl</code> CLI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/policy-server-cli.html">Policy Server CLI</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../personas.html">For who?</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../use-cases.html">Use cases</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../organization.html">Organization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../enterprise.html">Enterprise</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../glossary.html">Glossary</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../disclosure.html">Security disclosure</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Admission Controller</span>
    <span class="version">1.30-next</span>
  </div>
  <ul class="components">
        <li class="component is-current">
          <div class="title"><a href="../../../1.29/en/introduction.html">Admission Controller</a></div>
          <ul class="versions">
            <li class="version is-current">
              <a href="../introduction.html">1.30-next</a>
            </li>
            <li class="version is-latest">
              <a href="../../../1.29/en/introduction.html">1.29</a>
            </li>
            <li class="version">
              <a href="../../../1.28/en/introduction.html">1.28</a>
            </li>
            <li class="version">
              <a href="../../../1.27/en/introduction.html">1.27</a>
            </li>
            <li class="version">
              <a href="../../../1.26/en/introduction.html">1.26</a>
            </li>
            <li class="version">
              <a href="../../../1.25/en/introduction.html">1.25</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../cluster-api/latest/en/index.html">Cluster API</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../cluster-api/latest/en/index.html">Latest</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.24/en/index.html">0.24</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.23/en/index.html">0.23</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.22/en/index.html">0.22</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.21/en/index.html">0.21</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.20/en/index.html">0.20</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.19/en/index.html">0.19</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.18/en/index.html">0.18</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.17/en/index.html">0.17</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.16/en/index.html">0.16</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.15/en/index.html">0.15</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.14/en/index.html">0.14</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.13/en/index.html">0.13</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.12/en/index.html">0.12</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.11/en/index.html">0.11</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../continuous-delivery/v0.12/en/index.html">Continuous Delivery</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../continuous-delivery/v0.12/en/index.html">0.12</a>
            </li>
            <li class="version">
              <a href="../../../../continuous-delivery/v0.11/en/index.html">0.11</a>
            </li>
            <li class="version">
              <a href="../../../../continuous-delivery/v0.10/en/index.html">0.10</a>
            </li>
            <li class="version">
              <a href="../../../../continuous-delivery/v0.9/en/index.html">0.9</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../k3s/latest/en/introduction.html">K3s</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../k3s/latest/en/introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../os-manager/next/en/index.html">OS Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../os-manager/next/en/index.html">Next</a>
            </li>
            <li class="version">
              <a href="../../../../os-manager/latest/en/index.html">Latest</a>
            </li>
            <li class="version">
              <a href="../../../../os-manager/1.7/en/index.html">1.7</a>
            </li>
            <li class="version">
              <a href="../../../../os-manager/1.6/en/index.html">1.6</a>
            </li>
            <li class="version">
              <a href="../../../../os-manager/1.5/en/index.html">1.5</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../rke2/latest/en/introduction.html">RKE2</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../rke2/latest/en/introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../suse-observability/latest/en/classic.html">SUSE Observability</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../suse-observability/latest/en/classic.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html">SUSE® Rancher Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html">latest</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.12/en/about-rancher/what-is-rancher.html">v2.12</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.11/en/about-rancher/what-is-rancher.html">v2.11</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.10/en/about-rancher/what-is-rancher.html">v2.10</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.9/en/about-rancher/what-is-rancher.html">v2.9</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.8/en/about-rancher/what-is-rancher.html">v2.8</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../security/5.4/en/overview.html">SUSE® Security</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../security/5.4/en/overview.html">5.4</a>
            </li>
            <li class="version">
              <a href="../../../../security/5.3/en/overview.html">5.3</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../storage/latest/en/longhorn-documentation.html">SUSE® Storage</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../storage/latest/en/longhorn-documentation.html">Latest</a>
            </li>
            <li class="version">
              <a href="../../../../storage/1.11/en/longhorn-documentation.html">1.11 (Dev)</a>
            </li>
            <li class="version">
              <a href="../../../../storage/1.10/en/longhorn-documentation.html">1.10 (Dev)</a>
            </li>
            <li class="version">
              <a href="../../../../storage/1.9/en/longhorn-documentation.html">1.9 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../../storage/1.8/en/longhorn-documentation.html">1.8</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../virtualization/v1.5/en/introduction/overview.html">SUSE® Virtualization</a></div>
          <ul class="versions">
            <li class="version">
              <a href="../../../../virtualization/v1.6/en/introduction/overview.html">v1.6 (Dev)</a>
            </li>
            <li class="version is-latest">
              <a href="../../../../virtualization/v1.5/en/introduction/overview.html">v1.5 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../../virtualization/v1.4/en/introduction/overview.html">v1.4</a>
            </li>
            <li class="version">
              <a href="../../../../virtualization/v1.3/en/introduction/overview.html">v1.3</a>
            </li>
          </ul>
        </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
<ul>
    <li>
      <a href="https://documentation.suse.com/" title="documentation.suse.com" aria-label="SUSE Documentation Home">Documentation Home</a>
    </li>
    <li>
      <a href="https://documentation.suse.com/cloudnative/admission-controller" title="Admission Controller" aria-label="SUSE Documentation - Admission Controller">
        Admission Controller
      </a>
    </li>
      <li>
          Howtos
      </li>
  </ul>
</nav><div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">1.30-next</button>
  <div class="version-menu">
    <a class="version is-current" href="gatekeeper-migration.html">1.30-next</a>
    <a class="version" href="../../../1.29/en/howtos/gatekeeper-migration.html">1.29</a>
    <a class="version" href="../../../1.28/en/howtos/gatekeeper-migration.html">1.28</a>
    <a class="version" href="../../../1.27/en/howtos/gatekeeper-migration.html">1.27</a>
    <a class="version" href="../../../1.26/en/howtos/gatekeeper-migration.html">1.26</a>
    <a class="version is-missing" href="../../../1.25/en/introduction.html">1.25</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/rancher/kubewarden-product-docs/edit/main/docs/version-1.30/modules/en/pages/howtos/gatekeeper-migration.adoc"><strong>Edit</strong></a></div>
        <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <label class="visual-search-label-bc" for="search-input">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
          <input label="Search" aria-label="Search" id="search-input" type="text" placeholder="Search the docs" >
          <label class="filter checkbox" style="display: none">
            <input type="checkbox" data-facet-filter="component:admission-controller" checked> Only this project
          </label>
        </div>
      </div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="On this page" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is unreleased documentation for Admission Controller 1.30-next.</p>
</div>
</td>
</tr>
</table>
</div>
<h1 class="page">Migrating Gatekeeper Policies to SUSE Security Admission Controller</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>doc-persona:
  [kubewarden-operator, kubewarden-integrator, kubewarden-policy-developer]
doc-type: [howto]
doc-topic: [operator-manual]</p>
</div>
<div class="paragraph">
<p>This guide shows you how to convert an existing Gatekeeper policy into a
SUSE Security Admission Controller policy. This process involves two main steps:
. Compile the Rego program into a WebAssembly (Wasm) module.
. Distribute the WebAssembly module as a Admission Controller policy.</p>
</div>
<div class="paragraph">
<p>The <a href="../tutorials/writing-policies/rego/01-intro-rego.html" class="xref page">Rego policies
tutorial</a> covers most of the build process for compiling Rego code into a
WebAssembly module. This guide focuses on the step-by-step process of
extracting Gatekeeper Custom Resource Definitions (CRDs) and migrating them
into a functional Admission Controller policy. It uses a basic Gatekeeper demo policy.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/open-policy-agent/opa/releases">opa</a>: you use this tool
to build the code into wasm. This guide was written using the <code>v1.5.1</code> version.</p>
</li>
<li>
<p><a href="https://github.com/kubewarden/kwctl/releases"><code>kwctl</code></a>: tool you use to
prepare and run Admission Controller web assembly module</p>
</li>
<li>
<p><a href="https://github.com/bats-core/bats-core"><code>bats</code></a>: tool used to run end-to-end
tests. If you decided to write such kind of tests</p>
</li>
<li>
<p><a href="https://github.com/mikefarah/yq"><code>yq</code></a>: tool used to extract data from yaml files</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_before_migrating_your_policies"><a class="anchor" href="#_before_migrating_your_policies"></a>Before migrating your policies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before starting the process of migrating Gatekeeper policies, consider using
already available policies in the Admission Controller
<a href="https://artifacthub.io/packages/search?kind=13">catalog</a>. Some of the
<a href="https://github.com/kubewarden/rego-policies-library">policies</a> are publicly
available OPA and Gatekeeper policies migrated to Admission Controller.</p>
</div>
<div class="paragraph">
<p>Also, take a look at our
<a href="../explanations/comparisons/opa-comparison.html" class="xref page">comparison</a>
documentation between Admission Controller and Gatekeeper.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_1_initialize_your_admission_controller_policy_project"><a class="anchor" href="#_step_1_initialize_your_admission_controller_policy_project"></a>Step 1: Initialize Your Admission Controller policy project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, use the Admission Controller Gatekeeper
<a href="https://github.com/kubewarden/gatekeeper-policy-template">template</a> to create
a basic policy project structure. This provides Makefile targets for building
and testing your policy. After you create the policy code from the template,
run the Makefile commands to check the policy builds and tests run
successfully:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ make policy.wasm test
opa build -t wasm -e policy/violation -o bundle.tar.gz policy.rego
tar xvf bundle.tar.gz /policy.wasm
tar: Removing leading `/' from member names
/policy.wasm
rm bundle.tar.gz
touch policy.wasm # opa creates the bundle with unix epoch timestamp, fix it
opa test *.rego
PASS: 2/2</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_2_migrate_gatekeeper_policy_code"><a class="anchor" href="#_step_2_migrate_gatekeeper_policy_code"></a>Step 2: Migrate Gatekeeper policy code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now, begin migrating the Gatekeeper policy. This involves converting a
<code>ConstraintTemplate</code> and its associated <code>Constraint</code> resources into a Admission Controller
policy. In a Admission Controller context, consider the <code>ConstraintTemplate</code> as the core
policy code, while the <code>Constraint</code> instances translate into policy instances
running within Admission Controller.</p>
</div>
<div class="paragraph">
<p>First, copy the Rego code from your <code>ConstraintTemplate</code> into the <code>policy.rego</code>
file the Admission Controller template generated. For this example, you should use the
following basic
<a href="https://github.com/open-policy-agent/gatekeeper/blob/896d6620f9c16d7a5d91a74a6a4260db8d735640/demo/basic/demo.sh#L1">demo policy</a>
from the Gatekeeper repository.</p>
</div>
<details class="details">
<summary class="title">Gatekeeper policy yaml</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8srequiredlabels
spec:
  crd:
    spec:
      names:
        kind: K8sRequiredLabels
      validation:
        # Schema for the `parameters` field
        openAPIV3Schema:
          type: object
          properties:
            labels:
              type: array
              items:
                type: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8srequiredlabels

        violation[{"msg": msg, "details": {"missing_labels": missing}}] {
          provided := {label | input.review.object.metadata.labels[label]}
          required := {label | label := input.parameters.labels[_]}
          missing := required - provided
          count(missing) &gt; 0
          msg := sprintf("you must provide labels: %v", [missing])
        }</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>Copy the Rego code snippet from the <code>rego</code> field into your <code>policy.rego</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">cat gatekeeper/demo/basic/templates/k8srequiredlabels_template.yaml | yq ".spec.targets[0].rego" &gt; policy.rego</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_adapt_rego_code_for_admission_controller"><a class="anchor" href="#_adapt_rego_code_for_admission_controller"></a>Adapt Rego code for Admission Controller</h3>
<div class="paragraph">
<p>You need to make sure the <code>package</code> name used inside of the Rego code is <code>policy</code>.
This is the value expected in many places by the Admission Controller Gatekeeper template.</p>
</div>
<div class="paragraph">
<p>If you don&#8217;t change it, you will have errors when building the policy and running its end-to-end tests.</p>
</div>
<div class="paragraph">
<p>For example, the demo policy we&#8217;re converting is defined inside of the <code>k8srequiredlabels</code> package, this value must be changed to be <code>policy</code>.</p>
</div>
<div class="paragraph">
<p>This is how the contents of the <code>policy.rego</code> file have to be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-rego hljs" data-lang="rego">package policy

violation[{"msg": msg, "details": {"missing_labels": missing}}] {
provided := {label | input.review.object.metadata.labels[label]}
required := {label | label := input.parameters.labels[_]}
missing := required - provided
count(missing) &gt; 0
msg := sprintf("you must provide labels: %v", [missing])
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Attempting to build the code after this change might reveal new compilation errors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">opa build -t wasm -e policy/violation -o bundle.tar.gz policy.rego
error: load error: 2 errors occurred during loading:
policy.rego:3: rego_parse_error: `if` keyword is required before rule body
policy.rego:3: rego_parse_error: `contains` keyword is required for partial set rules
make: *** [Makefile:4: policy.wasm] Error 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The policy author must fix these errors to allow the <code>opa</code> CLI to build the
code successfully. The specific changes may vary depending on the <code>opa</code> version
and the original policy code. As we are migrating a rego
policy prior to OPA v1, we need to update the code to be v1-compliant. The
final <code>policy.rego</code> code looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-rego hljs" data-lang="rego">package policy

violation contains {"msg": msg, "details": {"missing_labels": missing}} if {
  provided := {label | input.review.object.metadata.labels[label]}
  required := {label | label := input.parameters.labels[_]}
  missing := required - provided
  count(missing) &gt; 0
  msg = sprintf("you must provide labels: %v", [missing])
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After you adjust the code, build the policy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ make policy.wasm
opa build -t wasm -e policy/violation -o bundle.tar.gz policy.rego
tar xvf bundle.tar.gz /policy.wasm
tar: Removing leading `/' from member names
/policy.wasm
rm bundle.tar.gz
touch policy.wasm # opa creates the bundle with unix epoch timestamp, fix it</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is more information on how to build Gatekeeper policies in our
<a href="../tutorials/writing-policies/rego/gatekeeper/03-build-and-run.html" class="xref page">tutorial</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rego_policy_code_and_opa_v1_0_0_compatibility"><a class="anchor" href="#_rego_policy_code_and_opa_v1_0_0_compatibility"></a>Rego Policy code and OPA v1.0.0 compatibility</h3>
<div class="paragraph">
<p>With the release of OPA (Open Policy Agent)
<a href="https://github.com/open-policy-agent/opa/releases/tag/v1.0.0">v1.0.0</a> in
December 2024, a breaking change was introduced regarding Rego policy syntax.</p>
</div>
<div class="paragraph">
<p>Previously, <code>if</code> for all rule definitions and <code>contains</code> for multi-value rules were
optional; now, they&#8217;re mandatory. This change affects most older policies.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a summary of what you need to know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>OPA v1.0.0 Syntax</strong>: OPA v1.0.0 mandates the use of <code>if</code> for all rule definitions
and <code>contains</code> for multi-value rules. Policies not adhering to this syntax will
break.</p>
</li>
<li>
<p><strong>Backward Compatibility</strong>: If you need to build older policies that don&#8217;t use
the new v1.0.0 syntax, you must provide the <code>--v0-compatible</code> flag to the <code>opa
build</code> command.</p>
</li>
<li>
<p><strong>Gatekeeper integration</strong>: Gatekeeper updated its OPA dependency to v1.0.0 in
its <a href="https://github.com/open-policy-agent/gatekeeper/releases/tag/v3.19.0">v3.19.0 release</a>.</p>
</li>
<li>
<p><strong>Rego version in Gatekeeper templates</strong>: Gatekeeper assumes <code>v0</code> syntax is used
unless the template explicitly specifies <code>version: "v1"</code> within the <code>source</code> field
under <code>code.engine: Rego</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See <a href="https://open-policy-agent.github.io/gatekeeper/website/docs/constrainttemplates/#enable-opa-rego-v1-syntax-in-constrainttemplates">this section</a>
of Gatekeeper&#8217;s docs for more details about how <code>v0</code> and <code>v1</code> versions of Rego
are handled.</p>
</div>
<div class="paragraph">
<p>What this means for you:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the Gatekeeper CR doesn&#8217;t specify a Rego version, it implies <code>v0</code> is going
to be used. You must build the policy using the <code>OPA_V0_COMPATIBLE=true
make</code> command.</p>
</li>
<li>
<p>If the Gatekeeper CR explicitly specifies <code>version: "v1"</code>, you must
build the policy without any environment variable set.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_3_update_and_run_tests"><a class="anchor" href="#_step_3_update_and_run_tests"></a>Step 3: Update and run tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>While highly recommended, policy authors might skip creating tests for the
initial version of a policy. If this applies to you, you&#8217;ll need to disable the
Makefile targets used to run tests. You can&#8217;t remove these targets entirely, as
the default CI jobs expect them to be defined. Instead, you should replace the
commands that call <code>opa</code> and <code>bats</code> with a "no-op" operation. For example, you can
use an <code>echo</code> command to print an explanation for why the tests aren&#8217;t being run.</p>
</div>
<div class="paragraph">
<p>The Admission Controller Gatekeeper template includes both Rego unit tests and end-to-end
(e2e) tests using Bats and <code>kwctl</code>. If you plan to include tests, both sets
need to be adapted for your policy.</p>
</div>
<div class="paragraph">
<p>If your Gatekeeper policy already has Rego tests, you can copy them into the
<code>policy_test.rego</code> file. These run automatically when you execute the
<code>make test</code> command.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Keep in mind that any Rego tests you write in <code>policy_test.rego</code> are subject to
the same compatibility issues detailed in the <a href="#_rego_policy_code_and_opa_v1_0_0_compatibility">Rego Policy code and OPA v1.0.0 Compatibility</a> section.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The policy you are migrating in this guide does not have tests; we need to add
them ourselves. Therefore, we&#8217;ll update the <code>policy_test.rego</code> test file
with some basic tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-rego hljs" data-lang="rego">package policy

review_required_labels := {
    "parameters": {"labels": ["test"]},
    "review": {"object": {"metadata": {"labels": {"test": "value"}}}},
}

review_missing_labels := {
    "parameters": {"labels": ["test"]},
    "review": {"object": {"metadata": {"labels": {"other": "value"}}}},
}

test_accept if {
    r = review_required_labels
    res = violation with input as r
    count(res) = 0
}

test_reject if {
    r = review_missing_labels
    res = violation with input as r
    count(res) = 1
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, running <code>make test</code> should validate your policy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ make policy.wasm test
opa build -t wasm -e policy/violation -o bundle.tar.gz policy.rego
tar xvf bundle.tar.gz /policy.wasm
tar: Removing leading `/' from member names
/policy.wasm
rm bundle.tar.gz
touch policy.wasm # opa creates the bundle with unix epoch timestamp, fix it
opa test *.rego
PASS: 2/2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, update the e2e tests file (<code>e2e.bats</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/usr/bin/env bats

@test "accept because required label is present" {
  run kwctl run -e gatekeeper annotated-policy.wasm --settings-path test_data/settings.json --request-path test_data/accept_deploy_request.json

  # this prints the output when one the checks below fails
  echo "output = ${output}"

  # request accepted
  [ "$status" -eq 0 ]
  [ $(expr "$output" : '.*allowed.*true') -ne 0 ]
}

@test "reject because required label is missing" {
run kwctl run -e gatekeeper annotated-policy.wasm --settings-path test_data/settings.json --request-path test_data/reject_deploy_request.json

  # this prints the output when one the checks below fails
  echo "output = ${output}"

  # request rejected
  [ "$status" -eq 0 ]
  [ $(expr "$output" : '.*allowed.*false') -ne 0 ]
  [ $(expr "$output" : '.*message.*you must provide labels: \[test\]') -ne 0 ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll need to create the <code>test_data/settings.json</code>,
<code>test_data/accept_deploy_request.json</code> and <code>test_data/reject_deploy_request.json</code>
files to support these tests.</p>
</div>
<details class="details">
<summary class="title">test_data/settings.json</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "labels": ["test"]
}</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>We won&#8217;t include the full content of <code>accept_deploy_request.json</code> and
<code>reject_deploy_request.json</code> here, as <code>AdmissionRequest</code> JSON can be quite
long, and we want to keep this guide concise. However, you can use the
<a href="../reference/kwctl-cli.html#_kwctl_scaffold_admission_request" class="xref page"><code>kwctl scaffold</code></a>
command to generate these files. The key for this guide is that one request
should be missing the required label, while the other should have the label
defined.</p>
</div>
<div class="paragraph">
<p>Check if the e2e tests are passing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ make e2e-tests
bats e2e.bats
e2e.bats
  ✓ accept because required label is present
  ✓ reject because required label is missing</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The policy parameters (for example, labels in
this example) originate from the policy settings. This allows you to deploy
multiple instances of the same policy with different parameters/settings,
similar to how Constraints function in Gatekeeper.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_4_prepare_metadata_yml_for_distribution"><a class="anchor" href="#_step_4_prepare_metadata_yml_for_distribution"></a>Step 4: Prepare <code>metadata.yml</code> for distribution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that you have a functional policy, prepare the <code>metadata.yml</code> file for
distribution. This file defines annotations with the policy description,
author, license, and other essential information. Crucially, it defines the
<code>rules</code> that specify which resources and verbs the policy can validate. This
information drives the <code>kwctl scaffold</code> command to generate the manifest for
deploying the policy in your cluster.</p>
</div>
<div class="paragraph">
<p>Gatekeeper&#8217;s <code>Constraints</code> CRDs, which are instances of policies defined in
<code>ConstraintTemplates</code>, specify which resources a policy instance evaluates.
Therefore, if you have existing <code>Constraints</code> that apply a <code>ConstraintTemplate</code>,
they offer a good reference for the resources you should define in your
<code>metadata.yml</code> file. For instance, in the Gatekeeper example used earlier, the
<code>K8sRequiredLabels</code> <code>Constraint</code> created from the <code>k8srequiredlabels</code>
<code>ConstraintTemplate</code> applies to <code>Namespaces</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: constraints.gatekeeper.sh/v1beta
kind: K8sRequiredLabels
metadata:
  name: ns-must-have-gk
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Namespace"]
  parameters:
    labels: ["gatekeeper"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Based on this, update the <code>rules</code> section of your <code>metadata.yml</code> to include a new
<code>rule</code> for validating <code>namespaces</code> during <code>CREATE</code> and <code>UPDATE</code> operations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">rules:
  - apiGroups: ["apps"]
    apiVersions: ["v1"]
    resources: ["deployments"]
    operations: ["CREATE", "UPDATE"]
  - apiGroups: [""]
    apiVersions: ["v1"]
    resources: ["namespaces"]
    operations: ["CREATE", "UPDATE"]
mutating: false
contextAware: false
executionMode: gatekeeper
backgroundAudit: true
annotations:
  io.artifacthub.displayName: Policy Name
  io.artifacthub.resources: Pod
  io.artifacthub.keywords: pod, cool policy, kubewarden
  io.kubewarden.policy.ociUrl: ghcr.io/yourorg/policies/policy-name
  io.kubewarden.policy.title: policy-name
  io.kubewarden.policy.version: 0.0.1-unreleased
  io.kubewarden.policy.description: Short description
  io.kubewarden.policy.author: "Author name &lt;author-email@example.com&gt;"
  io.kubewarden.policy.url: https://github.com/yourorg/policy-name
  io.kubewarden.policy.source: https://github.com/yourorg/policy-name
  io.kubewarden.policy.license: Apache-2.0
  io.kubewarden.policy.severity: medium
  io.kubewarden.policy.category: Resource validation</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, your policy is ready for distribution and deployment. Refer to the
<a href="../tutorials/writing-policies/rego/gatekeeper/04-distribute.html#_pushing_the_policy" class="xref page">Publishing the policy</a>
section from the tutorial to learn how to push it to a remote registry.</p>
</div>
<div class="paragraph">
<p>You can scaffold the policy manifest using <code>kwctl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kwctl scaffold manifest --type ClusterAdmissionPolicy annotated-policy.wasm
apiVersion: policies.kubewarden.io/v1
kind: ClusterAdmissionPolicy
metadata:
  annotations:
    io.kubewarden.policy.category: Resource validation
    io.kubewarden.policy.severity: medium
  name: policy-name
spec:
  module: file:///home/jvanz/SUSE/mygatekeeperpolicy/annotated-policy.wasm
  settings: {}
  rules:
  - apiGroups:
    - apps
    apiVersions:
    - v1
    resources:
    - deployments
    operations:
    - CREATE
    - UPDATE
  - apiGroups:
    - ''
    apiVersions:
    - v1
    resources:
    - namespaces
    operations:
    - CREATE
    - UPDATE
  mutating: false</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_define_policy_settings"><a class="anchor" href="#_define_policy_settings"></a>Define Policy Settings</h3>
<div class="paragraph">
<p>This policy has parameters, which Gatekeeper defines within the
<code>Constraint</code>. You need to update the <code>settings</code> section in the generated Admission Controller
policy manifest to include these required parameters. In the following example,
beyond defining the settings, you can test the policy from the OCI registry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: policies.kubewarden.io/v1
kind: ClusterAdmissionPolicy
metadata:
  annotations:
    io.kubewarden.policy.category: Resource validation
    io.kubewarden.policy.severity: medium
  name: policy-name
spec:
  module: registry://ghcr.io/jvanz/policies/mygatekeeperpolicy:latest
  settings:
    labels:
      - "gatekeeper"
  rules:
    - apiGroups:
        - apps
      apiVersions:
        - v1
      resources:
        - deployments
      operations:
        - CREATE
        - UPDATE
    - apiGroups:
        - ""
      apiVersions:
        - v1
      resources:
        - namespaces
      operations:
        - CREATE
        - UPDATE
  mutating: false</code></pre>
</div>
</div>
<div class="paragraph">
<p>Try to deploy a namespace missing the required <code>gatekeeper</code> label:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">kubectl apply -f - &lt;&lt;EOF
apiVersion: v1
kind: Namespace
metadata:
  name: your-namespace-name
  labels:
    purpose: demo
EOF
Error from server: error when creating "STDIN": admission webhook "clusterwide-policy-name.kubewarden.admission" denied the request: you must provide labels: [gatekeeper]</code></pre>
</div>
</div>
<div class="paragraph">
<p>And another namespace with the required label:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">kubectl apply -f - &lt;&lt;EOF
apiVersion: v1
kind: Namespace
metadata:
  name: your-namespace-name
  labels:
    purpose: demo
    gatekeeper: test
EOF

namespace/your-namespace-name created</code></pre>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="contribution-guide/suggesting-an-improvement.html">Improving documentation</a></span>
  <span class="next"><a href="../reference/CRDs.html">Custom Resource Definitions (CRD)</a></span>
</nav>
</article>
  </div>
</main>
</div>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../_/js/vendor/lunr-languages.js"></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="100" data-stylesheet="../../../../_/css/search.css"></script>
<script async src="../../../../search-index.js"></script>
<script src="../../../../_/js/vendor/langSelection.js"></script>
<script async src="../../../../_/js/vendor/tabs.js"></script>


<script src="../../../../_/js/CNLanguageSwitcher.js"></script>
  </body>
</html>
