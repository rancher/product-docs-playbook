<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Upgrade from v1.1.2 to v1.2.0 (not recommended) :: Rancher product documentation</title>
    <link rel="canonical" href="https://documentation.suse.com/cloudnative/virtualization/v1.5/en/upgrades/v1-1-2-to-v1-2-0.html">
    <link rel="prev" href="upgrades.html">
    <link rel="next" href="v1-2-0-to-v1-2-1.html">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../../_/css/site.css">
<meta http-equiv="last-modified" content="2025-06-04"/>
<link rel="stylesheet" href="../../../../_/css/search.css">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="../../../../_/css/font-styles.css">
<link rel="stylesheet" href="../../../../_/fonts/css/all.css">
<link rel="stylesheet" href="../../../../_/css/site-extra.css">
<link rel="stylesheet" href="../../../../_/css/vendor/tabs.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=SUSE:wght@100..800&display=swap&family=SUSE+Mono:ital,wght@0,100..800;1,100..800" rel="stylesheet">
<link href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css" rel="stylesheet">
<!-- <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto&display=swap" rel="stylesheet"> -->
<link rel="stylesheet" href="../../../../_/css/vendor/light.css">
<script src="/docserv/res/lightheaded/analytics.js" type="text/javascript"></script>

<script type="module">
  import { defineCustomElements, setAssetPath } from 'https://d12w0ryu9hjsx8.cloudfront.net/shared-header/1.5/shared-header.esm.js';
  defineCustomElements();
  setAssetPath("https://d12w0ryu9hjsx8.cloudfront.net/shared-header/1.5/assets");
</script>    <script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<script type="module">import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs'; mermaid.initialize({"startOnLoad":true});</script><!-- Canonical link -->
<link href="https://documentation.suse.com/cloudnative/virtualization/v1.5/en/upgrades/v1-1-2-to-v1-2-0.html" rel="canonical"/>

<!-- Default English link -->
<link href="https://documentation.suse.com/cloudnative/virtualization/v1.3/en/upgrades/v1-1-2-to-v1-2-0.html" hreflang="x-default" rel="alternate"/>

<!-- Link for the currently processed page -->
<link href="https://documentation.suse.com/cloudnative/virtualization/v1.3/en/upgrades/v1-1-2-to-v1-2-0.html" hrefLang="en-US" rel="alternate" />











<shared-header language="en" languages='{
"en": { "label": "English", "url": "https://documentation.suse.com/en-us/" },
"de": { "label": "Deutsch", "url": "https://documentation.suse.com/de-de/" },
"fr": { "label": "Français", "url": "https://documentation.suse.com/fr-fr/" },
"es": { "label": "Español", "url": "https://documentation.suse.com/es-es/" },
"zh_CN": { "label": "中文", "url": "https://documentation.suse.com/zh-cn/" },
"pt_BR": { "label": "Português Brasileiro", "url": "https://documentation.suse.com/pt-br/" }
}'>
</shared-header>

<!-- Leaving as a comment, I expect it will be required again next year.
<a target=_blank"" class="survey-link" href="https://suselinux.fra1.qualtrics.com/jfe/form/SV_bEiGZbUNzLD8Tcy"> Documentation survey </a>
--><div class="body">
<div class="nav-container" data-component="virtualization" data-version="v1.3">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title">SUSE® Virtualization</h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Introduction</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../introduction/overview.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../introduction/deploy-ha-cluster.html">Deploy a High-Availability Cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../introduction/deploy-singlenode-cluster.html">Deploy a Single-Node Cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../introduction/glossary.html">Glossary</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../introduction/document-conventions.html">Document Conventions</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Installation and Setup</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation-setup/requirements.html">Hardware and Network Requirements</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Installation Media</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../installation-setup/media/net-install.html">Net Install ISO</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../installation-setup/media/install-binaries-mode.html">Install Binaries Only</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Installation Methods</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../installation-setup/methods/iso-install.html">ISO Installation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../installation-setup/methods/usb-install.html">USB Installation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../installation-setup/methods/pxe-boot-install.html">PXE Boot Installation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../installation-setup/config/configuration-file.html">Configuration File</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../installation-setup/config/update-configuration.html">Update the Configuration After Installation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../installation-setup/config/settings.html">Settings</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../installation-setup/config/cloudinitcrd.html">CloudInit CRD</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation-setup/management-address.html">Management Address</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation-setup/authentication.html">Authentication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation-setup/airgap.html">Air-Gapped Environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation-setup/single-node-clusters.html">Single-Node Clusters</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Upgrades</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="upgrades.html">Upgrades</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="v1-1-2-to-v1-2-0.html">Upgrade from v1.1.2 to v1.2.0 (not recommended)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="v1-2-0-to-v1-2-1.html">Upgrade from v1.1.2/v1.1.3/v1.2.0 to v1.2.1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="v1-2-1-to-v1-2-2.html">Upgrade from v1.2.1 to v1.2.2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="v1-2-2-to-v1-3-1.html">Upgrade from v1.2.2/v1.3.0 to v1.3.1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="v1-3-1-to-v1-3-2.html">Upgrade from v1.3.1 to v1.3.2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="v1-3-2-to-v1-4-0.html">Upgrade from v1.3.2 to v1.4.0</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="troubleshooting.html">Troubleshooting</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Hosts</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hosts/hosts.html">Host Management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hosts/witness-node.html">Witness Node</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../hosts/vgpu-support.html">vGPU Support</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Virtual Machines</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../virtual-machines/virtual-machines.html">Virtual Machines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Virtual Machine Images</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../virtual-machines/vm-images/upload-image.html">Upload Images</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../virtual-machines/vm-images/custom-suse-images.html">Custom SUSE VM Images</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../virtual-machines/create-vm.html">Create a Virtual Machine</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../virtual-machines/create-windows-vm.html">Create a Windows Virtual Machine</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../virtual-machines/edit-vm.html">Edit a Virtual Machine</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../virtual-machines/access-vm.html">Access to the Virtual Machine</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../virtual-machines/backup-restore.html">VM Backup, Snapshot &amp; Restore</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../virtual-machines/live-migration.html">Live Migration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../virtual-machines/hotplug-volume.html">Hot-Plug Volumes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../virtual-machines/resource-overcommit.html">Resource Overcommit</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../virtual-machines/clone-vm.html">Clone VM</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Storage</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Volumes</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../storage/volumes/create-volume.html">Create a Volume</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../storage/volumes/edit-volume.html">Edit a Volume</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../storage/volumes/clone-volume.html">Clone a Volume</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../storage/volumes/export-volume.html">Export a Volume to Image</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../storage/volumes/volume-snapshots.html">Volume Snapshots</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../storage/storageclass.html">StorageClass</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../storage/csidriver.html">Third-Party Storage Support</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Networking</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/cluster-network.html">Cluster Network</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/vm-network.html">VM Network</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/deep-dive.html">Networking Deep Dive</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/load-balancer.html">Load Balancer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/ip-pool.html">IP Pool</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/storage-network.html">Storage Network</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/best-practices.html">Networking Best Practices</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Observability</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../observability/logging.html">Logging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../observability/monitoring.html">Monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../observability/calculation-resource-metrics.html">Calculation of Resource Metrics</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Add-ons</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../add-ons/add-ons.html">Add-ons</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../add-ons/harvester-seeder.html">Harvester Seeder</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../add-ons/nvidia-driver-toolkit.html">NVIDIA Driver Toolkit</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../add-ons/pcidevices-controller.html">PCI Devices Controller</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../add-ons/rancher-vcluster.html">Rancher Manager (Experimental)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../add-ons/vm-dhcp-controller.html">VM DHCP Controller (Managed DHCP)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../add-ons/vm-import-controller.html">VM Import Controller</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Integrations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Rancher Integration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../integrations/rancher/rancher-integration.html">SUSE Rancher Prime Integration</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../integrations/rancher/virtualization-management.html">Virtualization Management</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Node Driver</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../integrations/rancher/node-driver/node-driver.html">Harvester Node Driver</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../integrations/rancher/node-driver/rke1-cluster.html">Creating an RKE1 Kubernetes Cluster</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../integrations/rancher/node-driver/rke2-cluster.html">Creating an RKE2 Kubernetes Cluster</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../integrations/rancher/node-driver/k3s-cluster.html">Creating an K3s Kubernetes Cluster</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../integrations/rancher/cloud-provider.html">Harvester Cloud Provider</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../integrations/rancher/csi-driver.html">Harvester CSI Driver</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../integrations/rancher/resource-quota.html">Resource Quotas</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../integrations/rancher/rancher-terraform-provider.html">Rancher Terraform</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../integrations/rancher/import-vm.html">Import a Cluster Built on a SUSE® Virtualization VM</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../integrations/rancher/harvester-ui-extension.html">Harvester UI Extension</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../integrations/terraform/terraform-provider.html">Terraform Provider</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Troubleshooting</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../troubleshooting/faq.html">FAQ</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../troubleshooting/installation.html">Installation Issues</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../troubleshooting/operating-system.html">Operating System Issues</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../troubleshooting/cluster.html">Cluster Issues</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../troubleshooting/virtual-machines.html">Virtual Machine Issues</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../troubleshooting/monitoring.html">Monitoring Issues</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../troubleshooting/rancher.html">Rancher Issues</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Developer Content</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../developer/developer-mode-installation.html">Developer Mode</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../api.html">API</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">SUSE® Virtualization</span>
    <span class="version">v1.3</span>
  </div>
  <ul class="components">
        <li class="component">
          <div class="title"><a href="../../../../admission-controller/1.29/en/introduction.html">Admission Controller</a></div>
          <ul class="versions">
            <li class="version">
              <a href="../../../../admission-controller/1.30/en/introduction.html">1.30-next</a>
            </li>
            <li class="version is-latest">
              <a href="../../../../admission-controller/1.29/en/introduction.html">1.29</a>
            </li>
            <li class="version">
              <a href="../../../../admission-controller/1.28/en/introduction.html">1.28</a>
            </li>
            <li class="version">
              <a href="../../../../admission-controller/1.27/en/introduction.html">1.27</a>
            </li>
            <li class="version">
              <a href="../../../../admission-controller/1.26/en/introduction.html">1.26</a>
            </li>
            <li class="version">
              <a href="../../../../admission-controller/1.25/en/introduction.html">1.25</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../cluster-api/latest/en/index.html">Cluster API</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../cluster-api/latest/en/index.html">Latest</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.24/en/index.html">0.24</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.23/en/index.html">0.23</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.22/en/index.html">0.22</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.21/en/index.html">0.21</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.20/en/index.html">0.20</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.19/en/index.html">0.19</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.18/en/index.html">0.18</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.17/en/index.html">0.17</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.16/en/index.html">0.16</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.15/en/index.html">0.15</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.14/en/index.html">0.14</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.13/en/index.html">0.13</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.12/en/index.html">0.12</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.11/en/index.html">0.11</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../continuous-delivery/v0.12/en/index.html">Continuous Delivery</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../continuous-delivery/v0.12/en/index.html">0.12</a>
            </li>
            <li class="version">
              <a href="../../../../continuous-delivery/v0.11/en/index.html">0.11</a>
            </li>
            <li class="version">
              <a href="../../../../continuous-delivery/v0.10/en/index.html">0.10</a>
            </li>
            <li class="version">
              <a href="../../../../continuous-delivery/v0.9/en/index.html">0.9</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../k3s/latest/en/introduction.html">K3s</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../k3s/latest/en/introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../os-manager/next/en/index.html">OS Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../os-manager/next/en/index.html">Next</a>
            </li>
            <li class="version">
              <a href="../../../../os-manager/latest/en/index.html">Latest</a>
            </li>
            <li class="version">
              <a href="../../../../os-manager/1.7/en/index.html">1.7</a>
            </li>
            <li class="version">
              <a href="../../../../os-manager/1.6/en/index.html">1.6</a>
            </li>
            <li class="version">
              <a href="../../../../os-manager/1.5/en/index.html">1.5</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../rke2/latest/en/introduction.html">RKE2</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../rke2/latest/en/introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../suse-observability/latest/en/classic.html">SUSE Observability</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../suse-observability/latest/en/classic.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html">SUSE® Rancher Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html">latest</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.12/en/about-rancher/what-is-rancher.html">v2.12</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.11/en/about-rancher/what-is-rancher.html">v2.11</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.10/en/about-rancher/what-is-rancher.html">v2.10</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.9/en/about-rancher/what-is-rancher.html">v2.9</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.8/en/about-rancher/what-is-rancher.html">v2.8</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../security/5.4/en/overview.html">SUSE® Security</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../security/5.4/en/overview.html">5.4</a>
            </li>
            <li class="version">
              <a href="../../../../security/5.3/en/overview.html">5.3</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../storage/latest/en/longhorn-documentation.html">SUSE® Storage</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../storage/latest/en/longhorn-documentation.html">Latest</a>
            </li>
            <li class="version">
              <a href="../../../../storage/1.11/en/longhorn-documentation.html">1.11 (Dev)</a>
            </li>
            <li class="version">
              <a href="../../../../storage/1.10/en/longhorn-documentation.html">1.10 (Dev)</a>
            </li>
            <li class="version">
              <a href="../../../../storage/1.9/en/longhorn-documentation.html">1.9 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../../storage/1.8/en/longhorn-documentation.html">1.8</a>
            </li>
          </ul>
        </li>
        <li class="component is-current">
          <div class="title"><a href="../../../v1.5/en/introduction/overview.html">SUSE® Virtualization</a></div>
          <ul class="versions">
            <li class="version">
              <a href="../../../v1.6/en/introduction/overview.html">v1.6 (Dev)</a>
            </li>
            <li class="version is-latest">
              <a href="../../../v1.5/en/introduction/overview.html">v1.5 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../v1.4/en/introduction/overview.html">v1.4</a>
            </li>
            <li class="version is-current">
              <a href="../introduction/overview.html">v1.3</a>
            </li>
          </ul>
        </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
<ul>
    <li>
      <a href="https://documentation.suse.com/" title="documentation.suse.com" aria-label="SUSE Documentation Home">Documentation Home</a>
    </li>
    <li>
      <a href="https://documentation.suse.com/cloudnative/virtualization" title="SUSE Virtualization" aria-label="SUSE Documentation - SUSE Virtualization">
        SUSE Virtualization
      </a>
    </li>
      <li>
          Upgrades
      </li>
  </ul>
</nav><div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">v1.3</button>
  <div class="version-menu">
    <a class="version" href="../../../v1.6/en/upgrades/v1-1-2-to-v1-2-0.html">v1.6 (Dev)</a>
    <a class="version" href="../../../v1.5/en/upgrades/v1-1-2-to-v1-2-0.html">v1.5 (Latest)</a>
    <a class="version" href="../../../v1.4/en/upgrades/v1-1-2-to-v1-2-0.html">v1.4</a>
    <a class="version is-current" href="v1-1-2-to-v1-2-0.html">v1.3</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/rancher/harvester-product-docs/edit/main/versions/v1.3/modules/en/pages/upgrades/v1-1-2-to-v1-2-0.adoc"><strong>Edit</strong></a></div>
        <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <label class="visual-search-label-bc" for="search-input">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
          <input label="Search" aria-label="Search" id="search-input" type="text" placeholder="Search the docs" >
          <label class="filter checkbox" style="display: none">
            <input type="checkbox" data-facet-filter="component:virtualization" checked> Only this project
          </label>
        </div>
      </div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="On this page" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Upgrade from v1.1.2 to v1.2.0 (not recommended)</h1>
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Due to the known issues found v1.2.0:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_9_an_upgrade_is_stuck_in_the_post_draining_state">An Upgrade is stuck in the Post-draining state</a></p>
</li>
<li>
<p><a href="#_10_an_upgrade_is_stuck_in_the_upgrading_system_service_state_due_to_the_customer_provided_ssl_certificate_without_ip_san_error_in_fleet_agent">An upgrade is stuck in the Upgrading System Service state due to the customer provided SSL certificate without IP SAN error in fleet-agent</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We don&#8217;t recommend upgrading to v1.2.0. Please upgrade your v1.1.x cluster to v1.2.1.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_general_information"><a class="anchor" href="#_general_information"></a>General information</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Before you start an upgrade, you can run the pre-check script to make sure the cluster is in a stable state. For more details, please visit this <a href="https://github.com/harvester/upgrade-helpers/tree/main/pre-check/v1.1.x">URL</a> for the script.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once there is an upgradable version, the Harvester GUI Dashboard page will show an upgrade button. For more details, please refer to <a href="upgrades.html#_start_an_upgrade" class="xref page">start an upgrade</a>.</p>
</div>
<div class="paragraph">
<p>For the air-gap env upgrade, please refer to <a href="upgrades.html#_prepare_an_air_gapped_upgrade" class="xref page">prepare an air-gapped upgrade</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_known_issues"><a class="anchor" href="#_known_issues"></a>Known issues</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_an_upgrade_cant_start_and_reports_validator_harvesterhci_io_denied_the_request_managed_chart_rancher_monitoring_is_not_ready_please_wait_for_it_to_be_ready"><a class="anchor" href="#_1_an_upgrade_cant_start_and_reports_validator_harvesterhci_io_denied_the_request_managed_chart_rancher_monitoring_is_not_ready_please_wait_for_it_to_be_ready"></a>1. An upgrade can&#8217;t start and reports <code>"validator.harvesterhci.io" denied the request: managed chart rancher-monitoring is not ready, please wait for it to be ready</code></h3>
<div class="paragraph">
<p>If a cluster is configured with a <strong>storage network</strong>, an upgrade can&#8217;t start with the following message.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/upgrade/known_issues/3839-error.png" alt="3839 error">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Related issue:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/harvester/harvester/issues/3839">[Doc] upgrade stuck while upgrading system service with alertmanager and prometheus</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Workaround:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/harvester/harvester/issues/3839#issuecomment-1534438192" class="bare">https://github.com/harvester/harvester/issues/3839#issuecomment-1534438192</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_2_an_upgrade_is_stuck_in_creating_upgrade_repository"><a class="anchor" href="#_2_an_upgrade_is_stuck_in_creating_upgrade_repository"></a>2. An upgrade is stuck in <code>Creating Upgrade Repository</code></h3>
<div class="paragraph">
<p>During an upgrade, <strong>Creating Upgrade Repository</strong> is stuck in the <strong>Pending</strong> state:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/upgrade/known_issues/4246-pending.png" alt="4246 pending">
</div>
</div>
<div class="paragraph">
<p>Please perform the following steps to check if the cluster runs into the issue:</p>
</div>
<div class="openblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Check the upgrade repository pod:</p>
<div class="imageblock">
<div class="content">
<img src="../_images/upgrade/known_issues/4246-upgrade-repo-pod.png" alt="4246 upgrade repo pod">
</div>
</div>
<div class="paragraph">
<p>If the <code>virt-launcher-upgrade-repo-hvst-&lt;upgrade-name&gt;</code> pod stays in <code>ContainerCreating</code>, your cluster might have run into this issue. In this case, proceed with step 2.</p>
</div>
</li>
<li>
<p>Check the upgrade repository volume in the Longhorn GUI.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><a href="../troubleshooting/cluster.html#_access_embedded_rancher_and_longhorn_dashboards" class="xref page">Go to Longhorn GUI</a>.</p>
</li>
<li>
<p>Navigate to the <strong>Volume</strong> page.</p>
</li>
<li>
<p>Check the upgrade repository VM volume. It should be attached to a pod called <code>virt-launcher-upgrade-repo-hvst-&lt;upgrade-name&gt;</code>. If one of the volume&#8217;s replicas stays in <code>Stopped</code> (gray color), the cluster is running into the issue.</p>
<div class="imageblock">
<div class="content">
<img src="../_images/upgrade/known_issues/4246-pending-replica.png" alt="4246 pending replica">
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Related issue:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/harvester/harvester/issues/4246">[BUG] upgrade stuck on create upgrade VM</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Workaround:</p>
<div class="ulist">
<ul>
<li>
<p>Delete the <code>Stopped</code> replica from Longhorn GUI. Or,</p>
</li>
<li>
<p><a href="troubleshooting.html#_start_over_an_upgrade" class="xref page">Start over the upgrade</a>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_3_an_upgrade_is_stuck_when_pre_draining_a_node"><a class="anchor" href="#_3_an_upgrade_is_stuck_when_pre_draining_a_node"></a>3. An upgrade is stuck when pre-draining a node</h3>
<div class="paragraph">
<p>Starting from v1.1.0, Harvester will wait for all volumes to become healthy (when node count &gt;= 3) before upgrading a node. Generally, you can check volumes' health if an upgrade is stuck in the "pre-draining" state.</p>
</div>
<div class="paragraph">
<p>Visit <a href="../troubleshooting/cluster.html#_access_embedded_rancher_and_longhorn_dashboards" class="xref page">"Access Embedded Longhorn"</a> to see how to access the embedded Longhorn GUI.</p>
</div>
<div class="paragraph">
<p>You can also check the pre-drain job logs. Please refer to <a href="troubleshooting.html#_phase_4_upgrade_nodes" class="xref page">Phase 4: Upgrade nodes</a> in the troubleshooting guide.</p>
</div>
</div>
<div class="sect2">
<h3 id="_4_an_upgrade_is_stuck_in_upgrading_the_first_node_job_was_active_longer_than_the_specified_deadline"><a class="anchor" href="#_4_an_upgrade_is_stuck_in_upgrading_the_first_node_job_was_active_longer_than_the_specified_deadline"></a>4. An upgrade is stuck in upgrading the first node: Job was active longer than the specified deadline</h3>
<div class="paragraph">
<p>An upgrade fails, as shown in the screenshot below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/upgrade/known_issues/2894-deadline.png" alt="2894 deadline">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Related issue:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/harvester/harvester/issues/2894">[BUG] Upgrade stuck in upgrading first node: Job was active longer than specified deadline</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Workaround:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/harvester/harvester/issues/2894#issuecomment-1274069690" class="bare">https://github.com/harvester/harvester/issues/2894#issuecomment-1274069690</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_5_an_upgrade_is_stuck_in_the_pre_drained_state"><a class="anchor" href="#_5_an_upgrade_is_stuck_in_the_pre_drained_state"></a>5. An upgrade is stuck in the Pre-drained state</h3>
<div class="paragraph">
<p>You might see an upgrade is stuck in the "pre-drained" state:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/upgrade/known_issues/3730-stuck.png" alt="3730 stuck">
</div>
</div>
<div class="paragraph">
<p>In this stage, Kubernetes is supposed to drain the workload on the node, but some reasons might cause the process to stall.</p>
</div>
<div class="sect3">
<h4 id="_5_1_the_node_contains_a_longhorn_instance_manager_r_pod_that_serves_single_replica_volumes"><a class="anchor" href="#_5_1_the_node_contains_a_longhorn_instance_manager_r_pod_that_serves_single_replica_volumes"></a>5.1 The node contains a Longhorn <code>instance-manager-r</code> pod that serves single-replica volume(s)</h4>
<div class="paragraph">
<p>Longhorn doesn&#8217;t allow draining a node if the node contains the last surviving replica of a volume. To check if a node is running into this situation, follow these steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>List single-replica volumes with the command:</p>
<div class="listingblock">
<div class="content">
<pre> kubectl get volumes.longhorn.io -A -o yaml | yq '.items[] | select(.spec.numberOfReplicas == 1) | .metadata.namespace + "/" + .metadata.name'</pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> $ kubectl get volumes.longhorn.io -A -o yaml | yq '.items[] | select(.spec.numberOfReplicas == 1) | .metadata.namespace + "/" + .metadata.name'
 longhorn-system/pvc-d1f19bab-200e-483b-b348-c87cfbba85ab</pre>
</div>
</div>
</li>
<li>
<p>Check if the replica resides on the stuck node:</p>
<div class="paragraph">
<p>List the NodeID of the volume&#8217;s replica with the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> kubectl get replicas.longhorn.io -n longhorn-system -o yaml | yq '.items[] | select(.metadata.labels.longhornvolume == "&lt;volume&gt;") | .spec.nodeID'</pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> $ kubectl get replicas.longhorn.io -n longhorn-system -o yaml | yq '.items[] | select(.metadata.labels.longhornvolume == "pvc-d1f19bab-200e-483b-b348-c87cfbba85ab") | .spec.nodeID'
 node1</pre>
</div>
</div>
<div class="paragraph">
<p>If the result shows that the replica resides on the node where the upgrade is stuck (in this example, node1), your cluster is hitting this issue.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>There are a couple of ways to address this situation. Choose the most appropriate method for your VM:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Shut down the VM that uses the single-replica volume to detach the volume, allowing the upgrade to continue.</p>
</li>
<li>
<p>Adjust the volumes&#8217;s replicas to more than one.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><a href="../troubleshooting/cluster.html#_access_embedded_rancher_and_longhorn_dashboards" class="xref page">Go to Longhorn GUI</a>.</p>
</li>
<li>
<p>Go to the <strong>Volume</strong> page.</p>
</li>
<li>
<p>Locate the problematic volume and click the icon on the right side, then select <strong>Update Replicas Count</strong>:
<span class="image"><img src="../_images/upgrade/known_issues/4249-adjust-volume-replica.png" alt="4249 adjust volume replica"></span></p>
</li>
<li>
<p>Increase the <strong>Number of Replicas</strong> and select <strong>OK</strong>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_5_2_misconfigured_longhorn_instance_manager_r_pod_disruption_budgets_pdb"><a class="anchor" href="#_5_2_misconfigured_longhorn_instance_manager_r_pod_disruption_budgets_pdb"></a>5.2 Misconfigured Longhorn <code>instance-manager-r</code> Pod Disruption Budgets (PDB)</h4>
<div class="paragraph">
<p>A misconfigured PDB could cause this issue. To check if that&#8217;s the case, perform the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Assume the stuck node is <code>harvester-node-1</code>.</p>
</li>
<li>
<p>Check the <code>instance-manager-e</code> or <code>instance-manager-r</code> pod names on the stuck node:</p>
<div class="listingblock">
<div class="content">
<pre> $ kubectl get pods -n longhorn-system --field-selector spec.nodeName=harvester-node-1 | grep instance-manager
 instance-manager-r-d4ed2788          1/1     Running   0              3d8h</pre>
</div>
</div>
<div class="paragraph">
<p>The output above shows that the <code>instance-manager-r-d4ed2788</code> pod is on the node.</p>
</div>
</li>
<li>
<p>Check Rancher logs and verify that the <code>instance-manager-e</code> or <code>instance-manager-r</code> pod can&#8217;t be drained:</p>
<div class="listingblock">
<div class="content">
<pre> $ kubectl logs deployment/rancher -n cattle-system
 ...
 2023-03-28T17:10:52.199575910Z 2023/03/28 17:10:52 [INFO] [planner] rkecluster fleet-local/local: waiting: draining etcd node(s) custom-4f8cb698b24a,custom-a0f714579def
 2023-03-28T17:10:55.034453029Z evicting pod longhorn-system/instance-manager-r-d4ed2788
 2023-03-28T17:10:55.080933607Z error when evicting pods/"instance-manager-r-d4ed2788" -n "longhorn-system" (will retry after 5s): Cannot evict pod as it would violate the pod's disruption budget.</pre>
</div>
</div>
</li>
<li>
<p>Run the command to check if there is a PDB associated with the stuck node:</p>
<div class="listingblock">
<div class="content">
<pre> $ kubectl get pdb -n longhorn-system -o yaml | yq '.items[] | select(.spec.selector.matchLabels."longhorn.io/node"=="harvester-node-1") | .metadata.name'
 instance-manager-r-466e3c7f</pre>
</div>
</div>
</li>
<li>
<p>Check the owner of the instance manager to this PDB:</p>
<div class="listingblock">
<div class="content">
<pre> $ kubectl get instancemanager instance-manager-r-466e3c7f -n longhorn-system -o yaml | yq -e '.spec.nodeID'
 harvester-node-2</pre>
</div>
</div>
<div class="paragraph">
<p>If the output doesn&#8217;t match the stuck node (in this example output, <code>harvester-node-2</code> doesn&#8217;t match the stuck node <code>harvester-node-1</code>), then we can conclude this issue happens.</p>
</div>
</li>
<li>
<p>Before applying the workaround, check if all volumes are healthy:</p>
<div class="listingblock">
<div class="content">
<pre> kubectl get volumes -n longhorn-system -o yaml | yq '.items[] | select(.status.state == "attached")| .status.robustness'</pre>
</div>
</div>
<div class="paragraph">
<p>The output should all be <code>healthy</code>. If this is not the case, you might want to uncordon nodes to make the volume healthy again.</p>
</div>
</li>
<li>
<p>Remove the misconfigured PDB:</p>
<div class="listingblock">
<div class="content">
<pre>kubectl delete pdb instance-manager-r-466e3c7f -n longhorn-system</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Related issue:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/harvester/harvester/issues/3730">[BUG] 3 Node AirGapped Cluster Upgrade Stuck v1.1.0-&gt;v1.1.2-rc4</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_5_3_the_instance_manager_e_pod_could_not_be_drained"><a class="anchor" href="#_5_3_the_instance_manager_e_pod_could_not_be_drained"></a>5.3 The <code>instance-manager-e</code> pod could not be drained</h4>
<div class="paragraph">
<p>During an upgrade, you might encounter an issue where you can&#8217;t drain the <code>instance-manager-e</code> pod. When this situation occurs, you will see error messages in the Rancher logs like the ones shown below:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kubectl logs deployment/rancher -n cattle-system | grep "evicting pod"
evicting pod longhorn-system/instance-manager-r-a06a43f3437ab4f643eea7053b915a80
evicting pod longhorn-system/instance-manager-e-452e87d2
error when evicting pods/"instance-manager-r-a06a43f3437ab4f643eea7053b915a80" -n "Longhorn-system" (will retry after 5s): Cannot evict pod as it would violate the pod's disruption budget.
error when evicting pods/"instance-manager-e-452e87d2" -n "longhorn-system" (will retry after 5s): Cannot evict pod as it would violate the pod's disruption budget.</pre>
</div>
</div>
<div class="paragraph">
<p>Check the <code>instance-manager-e</code> to see if any engine instances remain.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kubectl get instancemanager instance-manager-e-452e87d2 -n longhorn-system -o yaml | yq -e ".status.instances"
pvc-7b120d60-1577-4716-be5a-62348271025a-e-1cd53c57:
  spec:
    name: pvc-7b120d60-1577-4716-be5a-62348271025a-e-1cd53c57
  status:
    endpoint: ""
    errorMsg: ""
    listen: ""
    portEnd: 10001
    portStart: 10001
    resourceVersion: 0
    state: running
    type: ""</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the <code>instance-manager-e-452e87d2</code> still has an engine instance, so you can&#8217;t drain the pod.</p>
</div>
<div class="paragraph">
<p>You need to check the engine numbers to see if any engine number is redundant. Each PVC should only have one engine.</p>
</div>
<div class="listingblock">
<div class="content">
<pre># kubectl get engines -n longhorn-system -l longhornvolume=pvc-7b120d60-1577-4716-be5a-62348271025a
NAME                                                  STATE     NODE               INSTANCEMANAGER                                      IMAGE                               AGE
pvc-76120d60-1577-4716-be5a-62348271025a-e-08220662   running   harvester-qv4hd    instance-manager-e-625d715e2f2e7065d64339f9b31407c2  longhornio/longhorn-engine:v1.4.3   2d12h
pvc-7b120d60-1577-4716-be5a-62348271025a-e-lcd53c57   running   harvester-lhlkv    instance-manager-e-452e87d2                          longhornio/longhorn-engine:v1.4.3   4d10h</pre>
</div>
</div>
<div class="paragraph">
<p>The example above shows that two engines exist for the same PVC, which is a known issue in Longhorn <a href="https://github.com/longhorn/longhorn/issues/6642">#6642</a>. To resolve this, delete the redundant engine to allow the upgrade to continue.</p>
</div>
<div class="paragraph">
<p>To determine which engine is the correct one, use the following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kubectl get volumes pvc-7b120d60-1577-4716-be5a-62348271025a -n longhorn-system
NAME                                      STATE     ROBUSTNESS  SCHEDULED SIZE        NODE            AGE
pvc-7b120d60-1577-4716-be5a-62348271025a  attached  healthy               42949672960 harvester-q4vhd 4d10h</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the volume <code>pvc-7b120d60-1577-4716-be5a-62348271025a</code> is active on the node <code>harvester-q4vhd</code>, indicating that the engine not running on this node is redundant.</p>
</div>
<div class="paragraph">
<p>To make the engine inactive and trigger its automatic deletion by Longhorn, run the following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kubectl patch engine pvc-7b120d60-1577-4716-be5a-62348271025a-e-lcd53c57 -n longhorn-system --type='json' -p='[{"op": "replace", "path": "/spec/active", "value": false}]'
engine.longhorn.io/pvc-7b120d60-1577-4716-be5a-62348271025a-e-lcd53c57 patched</pre>
</div>
</div>
<div class="paragraph">
<p>After a few seconds, you can verify the engine&#8217;s status:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kubectl get engine -n longhorn-system|grep pvc-7b120d60-1577-4716-be5a-62348271025a
pvc-7b120d60-1577-4716-be5a-62348271025a-e-08220b62   running  harvester-q4vhd   instance-manager-e-625d715e2f2e7065d64339f9631407c2  longhornio/longhorn-engine:v1.4.3   2d13h</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>instance-manager-e</code> pod should now drain successfully, allowing the upgrade to proceed.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Related issue:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/harvester/harvester/issues/4477">[BUG] Upgrade (v1.1.2 -&gt; v1.2.0-rc6) stuck in pre-drained</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_6_an_upgrade_is_stuck_in_the_upgrading_system_service_state"><a class="anchor" href="#_6_an_upgrade_is_stuck_in_the_upgrading_system_service_state"></a>6. An upgrade is stuck in the Upgrading System Service state</h3>
<div class="paragraph">
<p>If you notice the upgrade is stuck in the <strong>Upgrading System Service</strong> state for a long period of time, you might need to investigate if the upgrade is stuck in the <code>apply-manifests</code> phase.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/upgrade/known_issues/4484-apply-manifests-stuck.png" alt="4484 apply manifests stuck">
</div>
</div>
<div class="sect3">
<h4 id="_pod_prometheus_rancher_monitoring_prometheus_0_is_to_be_deleted"><a class="anchor" href="#_pod_prometheus_rancher_monitoring_prometheus_0_is_to_be_deleted"></a>POD prometheus-rancher-monitoring-prometheus-0 is to be deleted</h4>
<div class="openblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Check the log of the <code>apply-manifests</code> pod to see if the following messages repeat.</p>
<div class="listingblock">
<div class="content">
<pre> $ kubectl -n harvester-system logs hvst-upgrade-md6wr-apply-manifests-wqslg --tail=10
 Tue Sep  5 10:20:39 UTC 2023
 there are still 1 pods in cattle-monitoring-system to be deleted
 Tue Sep  5 10:20:45 UTC 2023
 there are still 1 pods in cattle-monitoring-system to be deleted
 Tue Sep  5 10:20:50 UTC 2023
 there are still 1 pods in cattle-monitoring-system to be deleted
 Tue Sep  5 10:20:55 UTC 2023
 there are still 1 pods in cattle-monitoring-system to be deleted
 Tue Sep  5 10:21:00 UTC 2023
 there are still 1 pods in cattle-monitoring-system to be deleted</pre>
</div>
</div>
</li>
<li>
<p>Check if the <code>prometheus-rancher-monitoring-prometheus-0</code> pod is stuck with the status <code>Terminating</code>.</p>
<div class="listingblock">
<div class="content">
<pre> $ kubectl -n cattle-monitoring-system get pods
 NAME                                         READY   STATUS        RESTARTS   AGE
 prometheus-rancher-monitoring-prometheus-0   0/3     Terminating   0          19d</pre>
</div>
</div>
</li>
<li>
<p>Find the UID of the terminating pod with the following command:</p>
<div class="listingblock">
<div class="content">
<pre> $ kubectl -n cattle-monitoring-system get pod prometheus-rancher-monitoring-prometheus-0 -o jsonpath='{.metadata.uid}'
 33f43165-6faa-4648-927d-69097901471c</pre>
</div>
</div>
</li>
<li>
<p>Get access to any node of the cluster via the console or SSH.</p>
</li>
<li>
<p>Search for the related log messages in <code>/var/lib/rancher/rke2/agent/logs/kubelet.log</code> using the pod&#8217;s UID.</p>
<div class="listingblock">
<div class="content">
<pre> E0905 10:26:18.769199   17399 reconciler.go:208] "operationExecutor.UnmountVolume failed (controllerAttachDetachEnabled true) for volume \"pvc-7781c988-c35b-4cf8-89e6-f2907ef33603\" (UniqueName: \"kubernetes.io/csi/driver.longhorn.io^pvc-7781c988-c35b-4cf8-89e6-f2907ef33603\") pod \"33f43165-6faa-4648-927d-69097901471c\" (UID: \"33f43165-6faa-4648-927d-69097901471c\") : UnmountVolume.NewUnmounter failed for volume \"pvc-7781c988-c35b-4cf8-89e6-f2907ef33603\" (UniqueName: \"kubernetes.io/csi/driver.longhorn.io^pvc-7781c988-c35b-4cf8-89e6-f2907ef33603\") pod \"33f43165-6faa-4648-927d-69097901471c\" (UID: \"33f43165-6faa-4648-927d-69097901471c\") : kubernetes.io/csi: unmounter failed to load volume data file [/var/lib/kubelet/pods/33f43165-6faa-4648-927d-69097901471c/volumes/kubernetes.io~csi/pvc-7781c988-c35b-4cf8-89e6-f2907ef33603/mount]: kubernetes.io/csi: failed to open volume data file [/var/lib/kubelet/pods/33f43165-6faa-4648-927d-69097901471c/volumes/kubernetes.io~csi/pvc-7781c988-c35b-4cf8-89e6-f2907ef33603/vol_data.json]: open /var/lib/kubelet/pods/33f43165-6faa-4648-927d-69097901471c/volumes/kubernetes.io~csi/pvc-7781c988-c35b-4cf8-89e6-f2907ef33603/vol_data.json: no such file or directory" err="UnmountVolume.NewUnmounter failed for volume \"pvc-7781c988-c35b-4cf8-89e6-f2907ef33603\" (UniqueName: \"kubernetes.io/csi/driver.longhorn.io^pvc-7781c988-c35b-4cf8-89e6-f2907ef33603\") pod \"33f43165-6faa-4648-927d-69097901471c\" (UID: \"33f43165-6faa-4648-927d-69097901471c\") : kubernetes.io/csi: unmounter failed to load volume data file [/var/lib/kubelet/pods/33f43165-6faa-4648-927d-69097901471c/volumes/kubernetes.io~csi/pvc-7781c988-c35b-4cf8-89e6-f2907ef33603/mount]: kubernetes.io/csi: failed to open volume data file [/var/lib/kubelet/pods/33f43165-6faa-4648-927d-69097901471c/volumes/kubernetes.io~csi/pvc-7781c988-c35b-4cf8-89e6-f2907ef33603/vol_data.json]: open /var/lib/kubelet/pods/33f43165-6faa-4648-927d-69097901471c/volumes/kubernetes.io~csi/pvc-7781c988-c35b-4cf8-89e6-f2907ef33603/vol_data.json: no such file or directory"</pre>
</div>
</div>
<div class="paragraph">
<p>If kubelet continues to complain about the volume failing to unmount, apply the following workaround to allow the upgrade to proceed.</p>
</div>
</li>
<li>
<p>Forcibly remove the pod stuck with the status <code>Terminating</code> with the following command:</p>
<div class="listingblock">
<div class="content">
<pre> kubectl delete pod prometheus-rancher-monitoring-prometheus-0 -n cattle-monitoring-system  --force</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Related issue</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/harvester/harvester/issues/4484">[BUG] The rancher-monitoring Pod stuck at terminating status when upgrading from v1.1.2 to v1.2.0-rc6</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_multiple_pods_in_cattle_monitoring_system_namespace_are_to_be_deleted"><a class="anchor" href="#_multiple_pods_in_cattle_monitoring_system_namespace_are_to_be_deleted"></a>Multiple PODs in cattle-monitoring-system namespace are to be deleted</h4>
<div class="openblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Check the log of the <code>apply-manifests</code> pod to see if the following messages repeat.</p>
<div class="listingblock">
<div class="content">
<pre> there are still 10 pods in cattle-monitoring-system to be deleted
 Fri Dec  8 19:06:56 UTC 2023
 there are still 10 pods in cattle-monitoring-system to be deleted
 Fri Dec  8 19:07:01 UTC 2023</pre>
</div>
</div>
<div class="paragraph">
<p>When it continues to show 10 (or other number) pods, it encounters below issue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre> The monitoring feature is deployed from the rancher-monitoring ManagedChart, in Harvester v1.2.0,v1.2.1,
 this ManagedChart is converted to Harvester Addon feature when upgrading.
 The ManagedChart rancher-monitoring is deleted, normally, all the generated resources including deployment,
 daemonset etc. will be deleted automatically. But in this case, those resources are not deleted.
 The above log reflects the result.
 Following instructions will guide to delete them manually.</pre>
</div>
</div>
</li>
<li>
<p>Locate the affected resources in the <code>cattle-monitoring-system</code> namespace.</p>
<div class="listingblock">
<div class="content">
<pre> Root level resources in cattle-monitoring-system

 Customized CRD: Prometheus
   Object: rancher-monitoring-prometheus
   Sub-object: statefulset.apps/prometheus-rancher-monitoring-prometheus

 Customized CRD: Alertmanager
   object:  rancher-monitoring-alertmanager
   Sub-object:  statefulset.apps/alertmanager-rancher-monitoring-alertmanager

 Deployment:
   rancher-monitoring-grafana
   rancher-monitoring-kube-state-metrics
   rancher-monitoring-operator
   rancher-monitoring-prometheus-adapter

 Daemonset:
   rancher-monitoring-prometheus-node-exporter</pre>
</div>
</div>
</li>
<li>
<p>Delete the affected resources.</p>
<div class="listingblock">
<div class="content">
<pre> Use below commands to delete them, meanwhile check the log of the `apply-manifests` until it does not
 report `there are still x pods in cattle-monitoring-system to be deleted`.

 kubectl delete prometheus rancher-monitoring-prometheus -n cattle-monitoring-system
 kubectl delete alertmanager rancher-monitoring-alertmanager -n cattle-monitoring-system

 kubectl delete deployment rancher-monitoring-grafana -n cattle-monitoring-system
 kubectl delete deployment rancher-monitoring-kube-state-metrics -n cattle-monitoring-system
 kubectl delete deployment rancher-monitoring-operator -n cattle-monitoring-system
 kubectl delete deployment rancher-monitoring-prometheus-adapter -n cattle-monitoring-system

 kubectl delete daemonset rancher-monitoring-prometheus-node-exporter -n cattle-monitoring-system</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You may need to run some of the commands more than once to completely delete the resources.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Related issue</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/harvester/harvester/issues/4846">[BUG] upgrade hung on apply-manifests</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_7_upgrade_stuck_in_the_upgrading_system_service_state"><a class="anchor" href="#_7_upgrade_stuck_in_the_upgrading_system_service_state"></a>7. Upgrade stuck in the <code>Upgrading System Service</code> state</h3>
<div class="paragraph">
<p>If an upgrade is stuck in an <code>Upgrading System Service</code> state for an extended period, some system services' certificates may have expired. To investigate and resolve this issue, follow these steps:</p>
</div>
<div class="openblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Find the <code>apply-manifest</code> job&#8217;s name with the command:</p>
<div class="listingblock">
<div class="content">
<pre> kubectl get jobs -n harvester-system -l harvesterhci.io/upgradeComponent=manifest</pre>
</div>
</div>
<div class="paragraph">
<p>Example output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> NAME                                 COMPLETIONS   DURATION   AGE
 hvst-upgrade-9gmg2-apply-manifests   0/1           46s        46s</pre>
</div>
</div>
</li>
<li>
<p>Check the job&#8217;s log with the command:</p>
<div class="listingblock">
<div class="content">
<pre> kubectl logs jobs/hvst-upgrade-9gmg2-apply-manifests -n harvester-system</pre>
</div>
</div>
<div class="paragraph">
<p>If the following messages appear in the log, continue to the next step:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> Waiting for CAPI cluster fleet-local/local to be provisioned (current phase: Provisioning, current generation: 30259)...
 Waiting for CAPI cluster fleet-local/local to be provisioned (current phase: Provisioning, current generation: 30259)...
 Waiting for CAPI cluster fleet-local/local to be provisioned (current phase: Provisioning, current generation: 30259)...
 Waiting for CAPI cluster fleet-local/local to be provisioned (current phase: Provisioning, current generation: 30259)...</pre>
</div>
</div>
</li>
<li>
<p>Check CAPI cluster&#8217;s state with the command:</p>
<div class="listingblock">
<div class="content">
<pre> kubectl get clusters.provisioning.cattle.io local -n fleet-local -o yaml</pre>
</div>
</div>
<div class="paragraph">
<p>If you see a condition similar to the one below, it&#8217;s likely that the cluster has encountered the issue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>     - lastUpdateTime: "2023-01-17T16:26:48Z"
       message: 'configuring bootstrap node(s) custom-24cb32ce8387: waiting for probes:
         kube-controller-manager, kube-scheduler'
       reason: Waiting
       status: Unknown
       type: Updated</pre>
</div>
</div>
</li>
<li>
<p>Find the machine&#8217;s hostname with the following command, and follow the <a href="https://github.com/harvester/harvester/issues/3863#issuecomment-1539681311">workaround</a> to see if service certificates expire on a node:</p>
<div class="listingblock">
<div class="content">
<pre> kubectl get machines.cluster.x-k8s.io -n fleet-local &lt;machine_name&gt; -o yaml | yq .status.nodeRef.name</pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>&lt;machine_name&gt;</code> with the machine&#8217;s name from the output in the previous step.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If multiple nodes joined the cluster around the same time, you should perform the <a href="https://github.com/harvester/harvester/issues/3863#issuecomment-1539681311">workaround</a> on all those nodes.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Related issue:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/harvester/harvester/issues/3863">[DOC/ENHANCEMENT] need to add cert-rotate feature, otherwise upgrade may stuck on Waiting for CAPI cluster fleet-local/local to be provisioned</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Workaround:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/harvester/harvester/issues/3863#issuecomment-1539681311" class="bare">https://github.com/harvester/harvester/issues/3863#issuecomment-1539681311</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_8_the_registry_suse_comharvester_betavmdplatest_image_is_not_available_in_air_gapped_environment"><a class="anchor" href="#_8_the_registry_suse_comharvester_betavmdplatest_image_is_not_available_in_air_gapped_environment"></a>8. The <code>registry.suse.com/harvester-beta/vmdp:latest</code> image is not available in air-gapped environment</h3>
<div class="paragraph">
<p>Harvester does not package the <code>registry.suse.com/harvester-beta/vmdp:latest</code> image in the ISO file as of v1.1.0. For Windows VMs before v1.1.0, they used this image as a container disk. However, kubelet may remove old images to free up bytes. Windows VMs can&#8217;t access an air-gapped environment when this image is removed. You can fix this issue by changing the image to <code>registry.suse.com/suse/vmdp/vmdp:2.5.4.2</code> and restarting the Windows VMs.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Related issue:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/harvester/harvester/issues/4534">[BUG] VMDP Image wrong after upgrade to Harvester 1.2.0</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_9_an_upgrade_is_stuck_in_the_post_draining_state"><a class="anchor" href="#_9_an_upgrade_is_stuck_in_the_post_draining_state"></a>9. An Upgrade is stuck in the Post-draining state</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This known issue is fixed in v1.2.1.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The node might be stuck in the OS upgrade process if you encounter the <strong>Post-draining</strong> state, as shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/upgrade/known_issues/stuck-in-post-draining.png" alt="stuck in post draining">
</div>
</div>
<div class="paragraph">
<p>Harvester uses <code>elemental upgrade</code> to help us upgrade the OS. Check the <code>elemental upgrade</code> logs to see if there are any errors.</p>
</div>
<div class="paragraph">
<p>You can check the <code>elemental upgrade</code> logs with the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">  # View the post-drain job, which should be named `hvst-upgrade-xxx-post-drain-xxx`
  $ kubectl get pod --selector=harvesterhci.io/upgradeJobType=post-drain -n harvester-system

  # Check the logs with the following command
  $ kubectl logs -n harvester-system pods/hvst-upgrade-xxx-post-drain-xxx</code></pre>
</div>
</div>
<div class="paragraph">
<p>Suppose you see the following error in the logs. An incomplete <code>state.yaml</code> causes this issue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Flag --directory has been deprecated, 'directory' is deprecated please use 'system' instead
INFO[2023-09-13T12:02:42Z] Starting elemental version 0.3.1
INFO[2023-09-13T12:02:42Z] reading configuration form '/tmp/tmp.N6rn4F6mKM'
ERRO[2023-09-13T12:02:42Z] Invalid upgrade command setup undefined state partition
elemental upgrade failed with return code: 33
+ ret=33
+ '[' 33 '!=' 0 ']'
+ echo 'elemental upgrade failed with return code: 33'
+ cat /host/usr/local/upgrade_tmp/elemental-upgrade-20230913120242.log</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, Harvester upgrades the elemental-cli to the latest version. It will try to find the <code>state</code> partition from the <code>state.yaml</code>. If the <code>state.yaml</code> is incomplete, there is a chance it will fail to find the <code>state</code> partition.</p>
</div>
<div class="paragraph">
<p>The incomplete <code>state.yaml</code> will look like the following.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># Autogenerated file by elemental client, do not edit

date: "2023-09-13T08:31:42Z"
state:
    # we are missing `label` here.
    active:
        source: dir:///tmp/tmp.01deNrXNEC
        label: COS_ACTIVE
        fs: ext2
    passive: null</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remove this incomplete <code>state.yaml</code> file to work around this issue. (The post-draining will retry every 10 minutes).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Remount the <code>state</code> partition to RW.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">  $ mount -o remount,rw /run/initramfs/cos-state</code></pre>
</div>
</div>
</li>
<li>
<p>Remove the <code>state.yaml</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">  $ rm -f /run/initramfs/cos-state/state.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Remount the <code>state</code> partition to RO.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">  $ mount -o remount,ro /run/initramfs/cos-state</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>After performing the steps above, you should pass post-draining with the next retry.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Related issues:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/harvester/harvester/issues/4526">[BUG] Upgrade stuck with first node in Post-draining state</a></p>
</li>
<li>
<p><a href="https://github.com/rancher/elemental-toolkit/issues/1827">A potential bug in NewElementalPartitionsFromList which caused upgrade error code 33</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Workaround:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/harvester/harvester/issues/4526#issuecomment-1732853216" class="bare">https://github.com/harvester/harvester/issues/4526#issuecomment-1732853216</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_10_an_upgrade_is_stuck_in_the_upgrading_system_service_state_due_to_the_customer_provided_ssl_certificate_without_ip_san_error_in_fleet_agent"><a class="anchor" href="#_10_an_upgrade_is_stuck_in_the_upgrading_system_service_state_due_to_the_customer_provided_ssl_certificate_without_ip_san_error_in_fleet_agent"></a>10. An upgrade is stuck in the Upgrading System Service state due to the <code>customer provided SSL certificate without IP SAN</code> error in <code>fleet-agent</code></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This known issue is fixed in v1.2.1.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If an upgrade is stuck in an <strong>Upgrading System Service</strong> state for an extended period, follow these steps to investigate this issue:</p>
</div>
<div class="openblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Find the pods related to the upgrade:</p>
<div class="listingblock">
<div class="content">
<pre> kubectl get pods -A | grep upgrade</pre>
</div>
</div>
<div class="paragraph">
<p>Example output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> # kubectl get pods -A | grep upgrade
 cattle-system               system-upgrade-controller-5685d568ff-tkvxb                 1/1     Running     0              85m
 harvester-system            hvst-upgrade-vq4hl-apply-manifests-65vv8                   1/1     Running     0              87m  // waiting for managedchart to be ready
 ..</pre>
</div>
</div>
</li>
<li>
<p>The pod <code>hvst-upgrade-vq4hl-apply-manifests-65vv8</code> has the following loop log:</p>
<div class="listingblock">
<div class="content">
<pre> Current version: 102.0.0+up40.1.2, Current state: WaitApplied, Current generation: 23
 Sleep for 5 seconds to retry</pre>
</div>
</div>
</li>
<li>
<p>Check the status for all bundles. Note thata couple of bundles are <code>OutOfSync</code>:</p>
<div class="listingblock">
<div class="content">
<pre> # kubectl get bundle -A
 NAMESPACE     NAME                                          BUNDLEDEPLOYMENTS-READY   STATUS
 ...
 fleet-local   mcc-local-managed-system-upgrade-controller   1/1
 fleet-local   mcc-rancher-logging                           0/1                       OutOfSync(1) [Cluster fleet-local/local]
 fleet-local   mcc-rancher-logging-crd                       0/1                       OutOfSync(1) [Cluster fleet-local/local]
 fleet-local   mcc-rancher-monitoring                        0/1                       OutOfSync(1) [Cluster fleet-local/local]
 fleet-local   mcc-rancher-monitoring-crd                    0/1                       WaitApplied(1) [Cluster fleet-local/local]</pre>
</div>
</div>
</li>
<li>
<p>The pod <code>fleet-agent-*</code> has following error log:</p>
<div class="listingblock">
<div class="content">
<pre> fleet-agent pod log:

 time="2023-09-19T12:18:10Z" level=error msg="Failed to register agent: looking up secret cattle-fleet-local-system/fleet-agent-bootstrap: Post \"https://192.168.122.199/apis/fleet.cattle.io/    v1alpha1/namespaces/fleet-local/clusterregistrations\": tls: failed to verify certificate: x509: cannot validate certificate for 192.168.122.199 because it doesn't contain any IP SANs"</pre>
</div>
</div>
</li>
<li>
<p>Check the <code>ssl-certificates</code> settings in Harvester:</p>
<div class="paragraph">
<p>From the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> # kubectl get settings.harvesterhci.io ssl-certificates
 NAME               VALUE
 ssl-certificates   {"publicCertificate":"-----BEGIN CERTIFICATE-----\nMIIFNDCCAxygAwIBAgIUS7DoHthR/IR30+H/P0pv6HlfOZUwDQYJKoZIhvcNAQEL\nBQAwFjEUMBIGA1UEAwwLZXhhbXBsZS5j...."}</pre>
</div>
</div>
<div class="paragraph">
<p>From the Harvester Web UI:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/upgrade/known_issues/4519-harvester-settings-ssl-certificates.png" alt="4519 harvester settings ssl certificates">
</div>
</div>
</li>
<li>
<p>Check the <code>server-url</code> setting, it is the value of VIP:</p>
<div class="listingblock">
<div class="content">
<pre>  # kubectl get settings.management.cattle.io -n cattle-system server-url
 NAME         VALUE
 server-url   https://192.168.122.199</pre>
</div>
</div>
</li>
<li>
<p>The root cause:</p>
<div class="paragraph">
<p>User sets the self-signed <code>ssl-certificates</code> with FQDN in the Harvester settings, but the <code>server-url</code> points to the VIP, the <code>fleet-agent</code> pod fails to register.</p>
</div>
<div class="listingblock">
<div class="content">
<pre> For example: create self-signed certificate for (*).example.com

 openssl req -x509 -newkey rsa:4096 -sha256 -days 3650 -nodes \
 -keyout example.key -out example.crt -subj "/CN=example.com" \
 -addext "subjectAltName=DNS:example.com,DNS:*.example.com"

 The general outputs are: example.crt, example.key</pre>
</div>
</div>
</li>
<li>
<p>The workaround:</p>
<div class="paragraph">
<p>Update <code>server-url</code> with the value of <code>https://harv31.example.com</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre> # kubectl edit settings.management.cattle.io -n cattle-system server-url
 setting.management.cattle.io/server-url edited
 ...

 # kubectl get settings.management.cattle.io -n cattle-system server-url
 NAME         VALUE
 server-url   https://harv31.example.com</pre>
</div>
</div>
<div class="paragraph">
<p>After the workaround is applied, the <code>fleet-agent</code> pod is replaced by Rancher automatically and registers successfully, the upgrade continues.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Related issue:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/harvester/harvester/issues/4519">[BUG] Upgrade to Harvester 1.2.0 fails in fleet-agent due to customer provided SSL certificate without IP SAN</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Workaround:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/harvester/harvester/issues/4519#issuecomment-1727132383" class="bare">https://github.com/harvester/harvester/issues/4519#issuecomment-1727132383</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_11_an_upgrade_is_denied_due_to_managed_chart_rancher_monitoring_crd_is_not_ready"><a class="anchor" href="#_11_an_upgrade_is_denied_due_to_managed_chart_rancher_monitoring_crd_is_not_ready"></a>11. An upgrade is denied due to <code>managed chart rancher-monitoring-crd is not ready</code></h3>
<div class="paragraph">
<p>When you <a href="upgrades.html#_start_an_upgrade" class="xref page">start an upgrade</a> and Harvester returns such an error message: <code>admission webhook "validator.harvesterhci.io" denied the request: managed chart rancher-monitoring-crd is not ready, please wait for it to be ready</code>. Please follow this <a href="../troubleshooting/monitoring.html#_rancher_monitoring_crd_managedchart_state_is_modified" class="xref page">troubleshooting</a>.</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="upgrades.html">Upgrades</a></span>
  <span class="next"><a href="v1-2-0-to-v1-2-1.html">Upgrade from v1.1.2/v1.1.3/v1.2.0 to v1.2.1</a></span>
</nav>
</article>
  </div>
</main>
</div>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../_/js/vendor/lunr-languages.js"></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="100" data-stylesheet="../../../../_/css/search.css"></script>
<script async src="../../../../search-index.js"></script>
<script src="../../../../_/js/vendor/langSelection.js"></script>
<script async src="../../../../_/js/vendor/tabs.js"></script>


<script src="../../../../_/js/CNLanguageSwitcher.js"></script>
  </body>
</html>
