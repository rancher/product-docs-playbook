<!DOCTYPE html>
<html lang="zh_cn">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
<title>高级选项和配置 | K3s  Latest</title>
    <link rel="canonical" href="https://documentation.suse.com/cloudnative/k3s/latest/zh/advanced.html">
    <link rel="prev" href="networking/networking-services.html">
    <link rel="next" href="reference/env-variables.html">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../_/css/site.css">
<meta http-equiv="last-modified" content="2025-12-31"/>
<link rel="stylesheet" href="../../../_/css/search.css">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="../../../_/css/font-styles.css">
<link rel="stylesheet" href="../../../_/fonts/css/all.css">
<link rel="stylesheet" href="../../../_/css/site-extra.css">
<link rel="stylesheet" href="../../../_/css/vendor/tabs.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=SUSE:wght@100..800&display=swap&family=SUSE+Mono:ital,wght@0,100..800;1,100..800" rel="stylesheet">
<link href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css" rel="stylesheet">
<link rel="stylesheet" href="../../../_/css/vendor/light.css">
<script src="/docserv/res/lightheaded/analytics.js" type="text/javascript"></script>
<script type="module">
  import { defineCustomElements, setAssetPath } from 'https://d12w0ryu9hjsx8.cloudfront.net/shared-header/1.10/shared-header.esm.js';
  defineCustomElements();
  setAssetPath("https://d12w0ryu9hjsx8.cloudfront.net/shared-header/1.10/assets");
</script>
<!-- Default English link -->
<link href="https://documentation.suse.com/cloudnative/k3s/latest/en/advanced.html" hreflang="x-default" rel="alternate"/>
<!-- Link for the currently processed page -->
<link href="https://documentation.suse.com/cloudnative/k3s/latest/zh/advanced.html" hrefLang="zh-CN" rel="alternate" />
<!-- Link for the English page -->
<link href="https://documentation.suse.com/cloudnative/k3s/latest/en/advanced.html" hreflang="en-US" rel="alternate" />
<!-- Link for the Korean page -->
<link href="https://documentation.suse.com/cloudnative/k3s/latest/ko/advanced.html" hreflang="ko-KR" rel="alternate" />
<!-- Link for the Japanese page -->
<link href="https://documentation.suse.com/cloudnative/k3s/latest/ja/advanced.html" hreflang="ja-JP" rel="alternate" />

<!-- JSON-LD for doc metadata -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "TechArticle",
  "name": "高级选项和配置 | SUSE Rancher Prime: K3s latest",
  "headline": "高级选项和配置",
  "description": "高级选项和配置",
  "inLanguage": "zh_cn",
  "dateModified": "2025-12-31T00:00:00Z",
  "author": {
    "@type": "Organization",
    "name": "SUSE Product & Solution Documentation Team",
    "url": "https://documentation.suse.com"
  },
  "mentions": [
    {
      "@type": "SoftwareApplication",
      "name": "SUSE Rancher Prime: K3s",
      "softwareVersion": "latest",
      "applicationCategory": "Cloud Infrastructure",
      "operatingSystem": "Linux"
    }
  ],
  "publisher": {
    "@type": "Organization",
    "name": "SUSE",
    "url": "https://documentation.suse.com",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.suse.com/assets/img/suse-white-logo-green.svg"
    }
  }
}
</script>
<!-- end JSON-LD for doc metadata -->
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<script type="module">import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs'; mermaid.initialize({"startOnLoad":true});</script><shared-header
language="en"
languages='{
    "en": { "label": "English", "url": "https://documentation.suse.com/en-us/" },
    "de": { "label": "Deutsch", "url": "https://documentation.suse.com/de-de/" },
    "fr": { "label": "Français", "url": "https://documentation.suse.com/fr-fr/" },
    "es": { "label": "Español", "url": "https://documentation.suse.com/es-es/" },
    "zh_CN": { "label": "中文", "url": "https://documentation.suse.com/zh-cn/" },
    "pt_BR": { "label": "Português Brasileiro", "url": "https://documentation.suse.com/pt-br/" }
}'
enable-search='false'>
</shared-header>

<!-- Leaving as a comment, I expect it will be required again next year.
<a target=_blank"" class="survey-link" href="https://suselinux.fra1.qualtrics.com/jfe/form/SV_bEiGZbUNzLD8Tcy"> Documentation survey </a>
--><div class="body">
<div class="nav-container" data-component="k3s" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title">K3s</h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="introduction.html">K3s - 轻量级 Kubernetes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="quick-start.html">快速入门指南</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="installation/installation.html">安装</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="installation/requirements.html">Requirements</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="installation/configuration.html">Configuration Options</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="installation/private-registry.html">Private Registry Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="installation/registry-mirror.html">Embedded Registry Mirror</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="installation/airgap.html">Air-Gap Install</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="installation/server-roles.html">Managing Server Roles</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="installation/packaged-components.html">Managing Packaged Components</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="installation/uninstall.html">Uninstalling K3s</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="datastore/datastore.html">集群数据存储</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="datastore/backup-restore.html">备份和恢复</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="datastore/ha-embedded.html">高可用嵌入式 etcd</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="datastore/ha.html">高可用外部数据库</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="datastore/cluster-loadbalancer.html">Cluster Load Balancer</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="upgrades/upgrades.html">升级</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="upgrades/killall.html">停止 K3s</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="upgrades/manual.html">手动升级</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="upgrades/automated.html">自动升级</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="upgrades/roll-back.html">Rolling Back K3s</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="security/security.html">安全</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security/secrets-encryption.html">Secret 加密配置</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security/hardening-guide.html">CIS Hardening Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security/self-assessment-1.11.html">CIS 1.11 Self Assessment Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security/self-assessment-1.10.html">CIS 1.10 Self Assessment Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security/self-assessment-1.9.html">CIS 1.9 Self Assessment Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security/self-assessment-1.8.html">CIS 1.8 Self Assessment Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security/self-assessment-1.7.html">CIS 1.7 Self Assessment Guide</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="cli/cli.html">CLI 工具</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cli/server.html">server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cli/agent.html">agent</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cli/certificate.html">certificate</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cli/etcd-snapshot.html">etcd-snapshot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cli/secrets-encrypt.html">secrets-encrypt</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cli/token.html">token</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="architecture.html">架构</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cluster-access.html">集群访问</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Add-Ons</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="add-ons/helm.html">Helm</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="add-ons/import-images.html">Import images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="add-ons/storage.html">卷和存储</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="networking/networking.html">Networking</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="networking/basic-network-options.html">Basic Network Options</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="networking/distributed-multicloud.html">Distributed hybrid or multicloud cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="networking/multus-ipams.html">Multus and IPAM plugins</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="networking/networking-services.html">网络</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="advanced.html">高级选项和配置</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">参考</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="reference/env-variables.html">环境变量</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="reference/flag-deprecation.html">Flag Deprecation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="reference/metrics.html">Metrics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="reference/resource-profiling.html">资源分析</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Release Notes</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="release-notes/v1.34.X.html">v1.34.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="release-notes/v1.33.X.html">v1.33.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="release-notes/v1.32.X.html">v1.32.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="release-notes/v1.31.X.html">v1.31.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Older&#8230;&#8203;</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="release-notes/v1.30.X.html">v1.30.X</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="release-notes/v1.29.X.html">v1.29.X</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="release-notes/v1.28.X.html">v1.28.X</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="release-notes/v1.27.X.html">v1.27.X</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="release-notes/v1.26.X.html">v1.26.X</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="release-notes/v1.25.X.html">v1.25.X</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="release-notes/v1.24.X.html">v1.24.X</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="related-projects.html">Related Projects</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="known-issues.html">已知问题</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="faq.html">常见问题</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">K3s</span>
    <span class="version">Latest</span>
  </div>
  <ul class="components">
        <li class="component">
          <div class="title"><a href="../../../admission-controller/1.31/en/introduction.html">Admission Controller</a></div>
          <ul class="versions">
            <li class="version">
              <a href="../../../admission-controller/1.32/en/introduction.html">1.32-dev</a>
            </li>
            <li class="version is-latest">
              <a href="../../../admission-controller/1.31/en/introduction.html">1.31-latest</a>
            </li>
            <li class="version">
              <a href="../../../admission-controller/1.30/en/introduction.html">1.30</a>
            </li>
            <li class="version">
              <a href="../../../admission-controller/1.29/en/introduction.html">1.29</a>
            </li>
            <li class="version">
              <a href="../../../admission-controller/1.28/en/introduction.html">1.28</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../cluster-api/v0.25/en/index.html">Cluster API</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../cluster-api/v0.25/en/index.html">0.25</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.24/en/index.html">0.24</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.23/en/index.html">0.23</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.22/en/index.html">0.22</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.21/en/index.html">0.21</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.20/en/index.html">0.20</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.19/en/index.html">0.19</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.18/en/index.html">0.18</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.17/en/index.html">0.17</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.16/en/index.html">0.16</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.15/en/index.html">0.15</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.14/en/index.html">0.14</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.13/en/index.html">0.13</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.12/en/index.html">0.12</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.11/en/index.html">0.11</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../continuous-delivery/v0.14/en/index.html">Continuous Delivery</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../continuous-delivery/v0.14/en/index.html">0.14</a>
            </li>
            <li class="version">
              <a href="../../../continuous-delivery/v0.13/en/index.html">0.13</a>
            </li>
            <li class="version">
              <a href="../../../continuous-delivery/v0.12/en/index.html">0.12</a>
            </li>
            <li class="version">
              <a href="../../../continuous-delivery/v0.11/en/index.html">0.11</a>
            </li>
            <li class="version">
              <a href="../../../continuous-delivery/v0.10/en/index.html">0.10</a>
            </li>
            <li class="version">
              <a href="../../../continuous-delivery/v0.9/en/index.html">0.9</a>
            </li>
          </ul>
        </li>
        <li class="component is-current">
          <div class="title"><a href="../en/introduction.html">K3s</a></div>
          <ul class="versions">
            <li class="version is-current is-latest">
              <a href="../en/introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../os-manager/1.8/en/index.html">OS Manager</a></div>
          <ul class="versions">
            <li class="version">
              <a href="../../../os-manager/1.9/en/index.html">1.9-dev</a>
            </li>
            <li class="version is-latest">
              <a href="../../../os-manager/1.8/en/index.html">1.8</a>
            </li>
            <li class="version">
              <a href="../../../os-manager/1.7/en/index.html">1.7</a>
            </li>
            <li class="version">
              <a href="../../../os-manager/1.6/en/index.html">1.6</a>
            </li>
            <li class="version">
              <a href="../../../os-manager/1.5/en/index.html">1.5</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../rke2/latest/en/introduction.html">RKE2</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../rke2/latest/en/introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../suse-observability/latest/en/classic.html">SUSE Observability</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../suse-observability/latest/en/classic.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../rancher-srfa/latest/en/about-rancher/what-is-rancher.html">SUSE® Rancher for AWS</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../rancher-srfa/latest/en/about-rancher/what-is-rancher.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../rancher-manager/v2.13/en/about-rancher/what-is-rancher.html">SUSE® Rancher Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../rancher-manager/v2.13/en/about-rancher/what-is-rancher.html">v2.13</a>
            </li>
            <li class="version">
              <a href="../../../rancher-manager/v2.12/en/about-rancher/what-is-rancher.html">v2.12</a>
            </li>
            <li class="version">
              <a href="../../../rancher-manager/v2.11/en/about-rancher/what-is-rancher.html">v2.11</a>
            </li>
            <li class="version">
              <a href="../../../rancher-manager/v2.10/en/about-rancher/what-is-rancher.html">v2.10</a>
            </li>
            <li class="version">
              <a href="../../../rancher-manager/v2.9/en/about-rancher/what-is-rancher.html">v2.9</a>
            </li>
            <li class="version">
              <a href="../../../rancher-manager/v2.8/en/about-rancher/what-is-rancher.html">v2.8</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../security/5.4/en/overview.html">SUSE® Security</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../security/5.4/en/overview.html">5.4</a>
            </li>
            <li class="version">
              <a href="../../../security/5.3/en/overview.html">5.3</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../storage/1.10/en/longhorn-documentation.html">SUSE® Storage</a></div>
          <ul class="versions">
            <li class="version">
              <a href="../../../storage/1.11/en/longhorn-documentation.html">1.11 (Dev)</a>
            </li>
            <li class="version is-latest">
              <a href="../../../storage/1.10/en/longhorn-documentation.html">1.10 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../storage/1.9/en/longhorn-documentation.html">1.9</a>
            </li>
            <li class="version">
              <a href="../../../storage/1.8/en/longhorn-documentation.html">1.8</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../suse-virtual-clusters/v1.0.1/en/introduction.html">SUSE® Virtual Clusters</a></div>
          <ul class="versions">
            <li class="version">
              <a href="../../../suse-virtual-clusters/1.0.2/en/introduction.html">1.0.2-dev</a>
            </li>
            <li class="version is-latest">
              <a href="../../../suse-virtual-clusters/v1.0.1/en/introduction.html">v1.0.1-latest</a>
            </li>
            <li class="version">
              <a href="../../../suse-virtual-clusters/v1.0.0/en/introduction.html">v1.0.0</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../virtualization/v1.6/en/introduction/overview.html">SUSE® Virtualization</a></div>
          <ul class="versions">
            <li class="version">
              <a href="../../../virtualization/v1.7/en/introduction/overview.html">v1.7 (Dev)</a>
            </li>
            <li class="version is-latest">
              <a href="../../../virtualization/v1.6/en/introduction/overview.html">v1.6 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../virtualization/v1.5/en/introduction/overview.html">v1.5</a>
            </li>
          </ul>
        </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
<ul>
    <li>
      <a class="home-link-dsc" href="https://documentation.suse.com/" title="documentation.suse.com" aria-label="SUSE Documentation Home"></a>
    </li>
    <li>
      <a href="https://documentation.suse.com/cloudnative/k3s" title="K3s" aria-label="SUSE Documentation - K3s">
        K3s
      </a>
    </li>
      <li>
          <a href="advanced.html" title="高级选项和配置" aria-label="高级选项和配置">高级选项和配置</a>
      </li>
  </ul>
</nav>  <div class="edit-this-page"><a href="https://github.com/rancher/k3s-product-docs/edit/main/docs/latest/modules/zh/pages/advanced.adoc"><strong>Edit</strong></a></div>
        <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <label class="visual-search-label-bc" for="search-input">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
          <input label="Search" aria-label="Search" id="search-input" type="text" placeholder="Search the docs" >
          <label class="filter checkbox" style="display: none">
            <input type="checkbox" data-facet-filter="component:k3s" checked> Only this project
          </label>
        </div>
      </div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="On this page" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">高级选项和配置</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>本文描述了用于运行和管理 K3s 的高级设置，以及为 K3s 准备主机操作系统所需的步骤。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_证书管理"><a class="anchor" href="#_证书管理"></a>证书管理</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ca_证书"><a class="anchor" href="#_ca_证书"></a>CA 证书</h3>
<div class="paragraph">
<p>K3s 在第一个 Server 节点启动时生成自签名 CA 证书。这些 CA 证书的有效期为 10 年，不会自动更新。</p>
</div>
<div class="paragraph">
<p>有关使用自定义 CA 证书或更新自签名 CA 证书的信息，请参阅 <a href="cli/certificate.html#_certificate_authority_ca_certificates" class="xref page"><code>k3s certificate rotate-ca</code> 命令文档</a>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_客户端和服务器证书"><a class="anchor" href="#_客户端和服务器证书"></a>客户端和服务器证书</h3>
<div class="paragraph">
<p>K3s 客户端和服务器证书自颁发日起 365 天内有效。每次启动 K3s 时，已过期或 90 天内过期的证书都会自动更新。</p>
</div>
<div class="paragraph">
<p>有关手动轮换客户端和服务器证书的信息，请参阅 <a href="cli/certificate.html#_client_and_server_certificates" class="xref page"><code>k3s certificate rotate</code> 命令文档</a>。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_token_管理"><a class="anchor" href="#_token_管理"></a>Token 管理</h2>
<div class="sectionbody">
<div class="paragraph">
<p>默认情况下，K3s 为 Server 和 Agent 使用单个静态 Token。With care, this token can be rotated once the cluster has been created。
你也可以启用只能用于加入 Agent 的第二个静态 Token，或创建自动过期的临时 <code>kubeadm</code> 联接样式 Token。
有关详细信息，请参阅 <a href="cli/token.html#_k3s_token_1" class="xref page"><code>k3s token</code> 命令文档</a>。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_dns_resolution"><a class="anchor" href="#_configuring_dns_resolution"></a>Configuring DNS Resolution</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_nameserver_viability_checks"><a class="anchor" href="#_nameserver_viability_checks"></a>Nameserver Viability Checks</h3>
<div class="paragraph">
<p>On startup, each node checks the files at <code>/etc/resolv.conf</code> and <code>/run/systemd/resolve/resolv.conf</code> for loopback, multicast, or link-local nameservers.
If any such entries are present, the configuration file is not used, as such entries would not function properly within pods that <a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pod-s-dns-policy">inherit name resolution configuration</a> from their node.
If no usable resolv.conf is found, K3s prints a warning message to the logs, and generate a stub resolv.conf that uses <code>8.8.8.8</code> and <code>2001:4860:4860::8888</code> as the nameservers.</p>
</div>
<div class="paragraph">
<p>If you want to provide K3s with an alternative resolver configuration without modifying the system configuration files, you may use the <code>--resolv-conf</code> option to specify the path to a suitable file.
Manually specified resolver configuration files are not subject to viability checks.</p>
</div>
</div>
<div class="sect2">
<h3 id="_coredns_custom_configuration_imports"><a class="anchor" href="#_coredns_custom_configuration_imports"></a>CoreDNS Custom Configuration Imports</h3>
<div class="paragraph">
<p>In order to customize the CoreDNS configuration, you may create a ConfigMap named <code>coredns-custom</code> in the <code>kube-system</code> namespace.
Keys matching <code>*.override</code> are imported into the <code>:.53</code> Server Block.
Additional Server Blocks may be placed in keys matching <code>*.server</code>.
Additional content (zone files, etc) may also be present, and are mounted under <code>/etc/coredns/custom</code> in the coredns pods.</p>
</div>
<div class="paragraph">
<p>Here is an example ConfigMap that forwards lookups to <code>example.com</code> to a nameserver at <code>10.0.0.1</code>, and serves <code>example.net</code> from an <a href="https://datatracker.ietf.org/doc/html/rfc1035#section-5">RFC 1035</a> compliant text file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns-custom
  namespace: kube-system
data:
  example-com.override: |
    forward example.com 10.0.0.1
  example-net.server: |
    example.net:53 {
      log
      errors
      file /etc/coredns/custom/db.example.net
    }
  db.example.net: |
    $ORIGIN example.net.
    @       3600 IN SOA    sns.dns.icann.org. noc.dns.icann.org. 2017042745 7200 3600 1209600 3600
            3600 IN NS     a.iana-servers.net.
            3600 IN NS     b.iana-servers.net.
    www          IN A      127.0.0.1
                 IN AAAA   ::1</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_配置_http_代理"><a class="anchor" href="#_配置_http_代理"></a>配置 HTTP 代理</h2>
<div class="sectionbody">
<div class="paragraph">
<p>如果你运行 K3s 的环境中只通过 HTTP 代理进行外部连接，你可以在 K3s 的 systemd 服务上配置代理。K3s 将使用这些代理设置，并向下传递到嵌入式 containerd 和 kubelet。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Proxy configuration and other environment variables from the host are NOT passed into Pods.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>K3s 安装脚本会自动使用当前 shell 中的 <code>HTTP_PROXY</code>、<code>HTTPS_PROXY</code> 和 <code>NO_PROXY</code>，以及 <code>CONTAINERD_HTTP_PROXY</code>、<code>CONTAINERD_HTTPS_PROXY</code> 和 <code>CONTAINERD_NO_PROXY</code> 变量（如果存在），并将它们写入 systemd 服务的环境文件，通常是：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>/etc/systemd/system/k3s.service.env</code></p>
</li>
<li>
<p><code>/etc/systemd/system/k3s-agent.service.env</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>你也可以通过编辑这些文件来配置代理。</p>
</div>
<div class="paragraph">
<p>K3s 会自动将集群内部 Pod 和 Service IP 范围以及集群 DNS 域添加到 <code>NO_PROXY</code> 条目列表中。你需要确保 Kubernetes 节点本身使用的 IP 地址范围（即节点的公共和私有 IP）包含在 <code>NO_PROXY</code> 列表中，或者可以通过代理访问节点。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>HTTP_PROXY=http://your-proxy.example.com:8888
HTTPS_PROXY=http://your-proxy.example.com:8888
NO_PROXY=127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16</pre>
</div>
</div>
<div class="paragraph">
<p>如果你想在不影响 K3s 和 Kubelet 的情况下为 containerd 配置代理，你可以在变量前加上 <code>CONTAINERD_</code>：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CONTAINERD_HTTP_PROXY=http://your-proxy.example.com:8888
CONTAINERD_HTTPS_PROXY=http://your-proxy.example.com:8888
CONTAINERD_NO_PROXY=127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_使用_docker_作为容器运行时"><a class="anchor" href="#_使用_docker_作为容器运行时"></a>使用 Docker 作为容器运行时</h2>
<div class="sectionbody">
<div class="paragraph">
<p>K3s 包含并默认为 <a href="https://containerd.io/">containerd</a>，它是一个行业标准的容器运行时。
从 Kubernetes 1.24 开始，Kubelet 不再包含 dockershim，该组件允许 kubelet 与 dockerd 通信。
K3s 1.24 及更高版本包括了 <a href="https://github.com/Mirantis/cri-dockerd">cri-dockerd</a>，它允许你无缝升级旧的 K3s 版本，同时继续使用 Docker 容器运行时。</p>
</div>
<div class="paragraph">
<p>要使用 Docker 而不是 containerd：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在 K3s 节点上安装 Docker。你可以使用 Rancher 的一个 <a href="https://github.com/rancher/install-docker">Docker 安装脚本</a>来安装 Docker：</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl https://releases.rancher.com/install-docker/20.10.sh | sh</code></pre>
</div>
</div>
</li>
<li>
<p>使用 <code>--docker</code> 选项安装 K3s：</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -sfL https://get.k3s.io | sh -s - --docker</code></pre>
</div>
</div>
</li>
<li>
<p>确认集群可用：</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ sudo k3s kubectl get pods --all-namespaces
NAMESPACE     NAME                                     READY   STATUS      RESTARTS   AGE
kube-system   local-path-provisioner-6d59f47c7-lncxn   1/1     Running     0          51s
kube-system   metrics-server-7566d596c8-9tnck          1/1     Running     0          51s
kube-system   helm-install-traefik-mbkn9               0/1     Completed   1          51s
kube-system   coredns-8655855d6-rtbnb                  1/1     Running     0          51s
kube-system   svclb-traefik-jbmvl                      2/2     Running     0          43s
kube-system   traefik-758cd5fc85-2wz97                 1/1     Running     0          43s</code></pre>
</div>
</div>
</li>
<li>
<p>确认 Docker 容器正在运行：</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ sudo docker ps
CONTAINER ID        IMAGE                     COMMAND                  CREATED              STATUS              PORTS               NAMES
3e4d34729602        897ce3c5fc8f              "entry"                  About a minute ago   Up About a minute                       k8s_lb-port-443_svclb-traefik-jbmvl_kube-system_d46f10c6-073f-4c7e-8d7a-8e7ac18f9cb0_0
bffdc9d7a65f        rancher/klipper-lb        "entry"                  About a minute ago   Up About a minute                       k8s_lb-port-80_svclb-traefik-jbmvl_kube-system_d46f10c6-073f-4c7e-8d7a-8e7ac18f9cb0_0
436b85c5e38d        rancher/library-traefik   "/traefik --configfi…"   About a minute ago   Up About a minute                       k8s_traefik_traefik-758cd5fc85-2wz97_kube-system_07abe831-ffd6-4206-bfa1-7c9ca4fb39e7_0
de8fded06188        rancher/pause:3.1         "/pause"                 About a minute ago   Up About a minute                       k8s_POD_svclb-traefik-jbmvl_kube-system_d46f10c6-073f-4c7e-8d7a-8e7ac18f9cb0_0
7c6a30aeeb2f        rancher/pause:3.1         "/pause"                 About a minute ago   Up About a minute                       k8s_POD_traefik-758cd5fc85-2wz97_kube-system_07abe831-ffd6-4206-bfa1-7c9ca4fb39e7_0
ae6c58cab4a7        9d12f9848b99              "local-path-provisio…"   About a minute ago   Up About a minute                       k8s_local-path-provisioner_local-path-provisioner-6d59f47c7-lncxn_kube-system_2dbd22bf-6ad9-4bea-a73d-620c90a6c1c1_0
be1450e1a11e        9dd718864ce6              "/metrics-server"        About a minute ago   Up About a minute                       k8s_metrics-server_metrics-server-7566d596c8-9tnck_kube-system_031e74b5-e9ef-47ef-a88d-fbf3f726cbc6_0
4454d14e4d3f        c4d3d16fe508              "/coredns -conf /etc…"   About a minute ago   Up About a minute                       k8s_coredns_coredns-8655855d6-rtbnb_kube-system_d05725df-4fb1-410a-8e82-2b1c8278a6a1_0
c3675b87f96c        rancher/pause:3.1         "/pause"                 About a minute ago   Up About a minute                       k8s_POD_coredns-8655855d6-rtbnb_kube-system_d05725df-4fb1-410a-8e82-2b1c8278a6a1_0
4b1fddbe6ca6        rancher/pause:3.1         "/pause"                 About a minute ago   Up About a minute                       k8s_POD_local-path-provisioner-6d59f47c7-lncxn_kube-system_2dbd22bf-6ad9-4bea-a73d-620c90a6c1c1_0
64d3517d4a95        rancher/pause:3.1         "/pause"</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_使用_etcdctl"><a class="anchor" href="#_使用_etcdctl"></a>使用 etcdctl</h2>
<div class="sectionbody">
<div class="paragraph">
<p>etcdctl 提供了一个与 etcd 服务器交互的 CLI。K3s 附带 etcdctl。</p>
</div>
<div class="paragraph">
<p>如果你想使用 etcdctl 与 K3s 的嵌入式 etcd 进行交互，请参阅<a href="https://etcd.io/docs/latest/install/">官方文档</a>安装 etcdctl。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ETCD_VERSION="v3.5.5"
ETCD_URL="https://github.com/etcd-io/etcd/releases/download/${ETCD_VERSION}/etcd-${ETCD_VERSION}-linux-amd64.tar.gz"
curl -sL ${ETCD_URL} | sudo tar -zxv --strip-components=1 -C /usr/local/bin</code></pre>
</div>
</div>
<div class="paragraph">
<p>然后，你可以将 etcdctl 配置为使用 K3s 管理的证书和密钥来进行身份验证，从而使用 etcdctl：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo etcdctl version \
  --cacert=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt \
  --cert=/var/lib/rancher/k3s/server/tls/etcd/client.crt \
  --key=/var/lib/rancher/k3s/server/tls/etcd/client.key</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_配置_containerd"><a class="anchor" href="#_配置_containerd"></a>配置 Containerd</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Version Gate</div>
<div class="paragraph">
<p>K3s includes containerd 2.0 as of the February 2025 releases: v1.31.6+k3s1 and v1.32.2+k3s1.
Be aware that containerd 2.0 prefers config version 3, while containerd 1.7 prefers config version 2.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>K3s will generate a configuration file for containerd at <code>/var/lib/rancher/k3s/agent/etc/containerd/config.toml</code>, using values specific to the current cluster and node configuration.</p>
</div>
<div class="paragraph">
<p>For advanced customization, you can create a containerd config template in the same directory:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For containerd 2.0, place a version 3 configuration template in <code>config-v3.toml.tmpl</code>.</p>
<div class="paragraph">
<p>See the <a href="https://github.com/containerd/containerd/blob/release/2.0/docs/cri/config.md">containerd 2.0 documentation</a> for more information.</p>
</div>
</li>
<li>
<p>For containerd 1.7 and earlier, place a version 2 configuration template in <code>config.toml.tmpl</code>.</p>
<div class="paragraph">
<p>See the <a href="https://github.com/containerd/containerd/blob/release/1.7/docs/cri/config.md">containerd 1.7 documentation</a> for more information.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Containerd 2.0 is backwards compatible with prior config versions, and k3s will continue to render legacy version 2 configuration from <code>config.toml.tmpl</code> if <code>config-v3.toml.tmpl</code> is not found.</p>
</div>
<div class="paragraph">
<p>The template file is rendered into the containerd config using the <a href="https://pkg.go.dev/text/template"><code>text/template</code></a> library.
See <code>ContainerdConfigTemplateV3</code> and <code>ContainerdConfigTemplate</code> in <a href="https://github.com/k3s-io/k3s/blob/main/pkg/agent/templates/templates.go"><code>templates.go</code></a> for the default template content.
The template is executed with a <a href="https://github.com/k3s-io/k3s/blob/main/pkg/agent/templates/templates.go#L22-L33"><code>ContainerdConfig</code></a> struct as its dot value (data argument).</p>
</div>
<div class="sect2">
<h3 id="_base_template"><a class="anchor" href="#_base_template"></a>Base template</h3>
<div class="paragraph">
<p>You can extend the K3s base template instead of copy-pasting the complete stock template out of the K3s source code. This is useful if you only need to build on the existing configuration by adding a few extra lines before or after the defaults.</p>
</div>
<div class="listingblock">
<div class="title">/var/lib/rancher/k3s/agent/etc/containerd/config-v3.toml.tmpl</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">{{ template "base" . }}

[plugins.'io.containerd.cri.v1.runtime'.containerd.runtimes.'custom']
  runtime_type = "io.containerd.runc.v2"
[plugins.'io.containerd.cri.v1.runtime'.containerd.runtimes.'custom'.options]
  BinaryName = "/usr/bin/custom-container-runtime"
  SystemdCgroup = true</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For best results, do NOT simply copy a prerendered <code>config.toml</code> into the template and make your desired changes. Use the base template, or provide a full template based on the k3s defaults linked above.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_alternative_容器运行时支持"><a class="anchor" href="#_alternative_容器运行时支持"></a>Alternative 容器运行时支持</h2>
<div class="sectionbody">
<div class="paragraph">
<p>K3s will automatically detect alternative container runtimes if they are present when K3s starts. Supported container runtimes are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>crun, lunatic, nvidia, nvidia-cdi, nvidia-experimental, slight, spin, wasmedge, wasmer, wasmtime, wws</pre>
</div>
</div>
<div class="paragraph">
<p>NVIDIA GPUs require installation of the NVIDIA Container Runtime in order to schedule and run accelerated workloads in Pods. To use NVIDIA GPUs with K3s, perform the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>按照以下说明在节点上安装 nvidia-container 包仓库：
<a href="https://nvidia.github.io/libnvidia-container/" class="bare">https://nvidia.github.io/libnvidia-container/</a></p>
</li>
<li>
<p>安装 nvidia 容器运行时包。例如：
<code>apt install -y nvidia-container-runtime cuda-drivers-fabricmanager-515 nvidia-headless-515-server</code></p>
</li>
<li>
<p><a href="installation/installation.html" class="xref page">Install K3s</a>, or restart it if already installed.</p>
</li>
<li>
<p>Confirm that the nvidia container runtime has been found by k3s:
<code>grep nvidia /var/lib/rancher/k3s/agent/etc/containerd/config.toml</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>K3s includes Kubernetes RuntimeClass definitions for all supported alternative runtimes. You can select one of these to replace <code>runc</code> as the default runtime on a node by setting the <code>--default-runtime</code> value via the k3s CLI or config file.</p>
</div>
<div class="paragraph">
<p>If you have not changed the default runtime on your GPU nodes, you must explicitly request the NVIDIA runtime by setting <code>runtimeClassName: nvidia</code> in the Pod spec:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Pod
metadata:
  name: nbody-gpu-benchmark
  namespace: default
spec:
  restartPolicy: OnFailure
  runtimeClassName: nvidia
  containers:
  - name: cuda-container
    image: nvcr.io/nvidia/k8s/cuda-sample:nbody
    args: ["nbody", "-gpu", "-benchmark"]
    resources:
      limits:
        nvidia.com/gpu: 1
    env:
    - name: NVIDIA_VISIBLE_DEVICES
      value: all
    - name: NVIDIA_DRIVER_CAPABILITIES
      value: all</code></pre>
</div>
</div>
<div class="paragraph">
<p>请注意，NVIDIA Container Runtime 也经常与 <a href="https://github.com/NVIDIA/k8s-device-plugin/">NVIDIA Device Plugin</a> 和 <a href="https://github.com/NVIDIA/gpu-feature-discovery/">GPU Feature Discovery</a> 一起使用，它们必须单独安装，而且需要修改以确保 Pod 规范能包括 <code>runtimeClassName: nvidia</code>，如前所述。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_agentless_servers_experimental"><a class="anchor" href="#_running_agentless_servers_experimental"></a>运行无 Agent 的 Server（实验性）</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>警告</strong>：此功能是实验性的。</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>当使用 <code>--disable-agent</code> 标志启动时，Server 不运行 kubelet、容器运行时或 CNI。它们不会在集群中注册 Node 资源，也不会出现在 <code>kubectl get nodes</code> 输出中。
因为它们不托管 kubelet，所以它们不能运行 pod，也不能由依赖枚举集群节点的 Operator 管理，包括嵌入式 etcd controller 和 system-upgrade-controller。</p>
</div>
<div class="paragraph">
<p>如果你想让 control plane 节点不被 Agent 和工作负载发现，你可以运行无 Agent 的 Server，但是代价是由于缺乏集群 Operator 支持，管理开销会增加。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_使用_rootless_模式运行_server实验性"><a class="anchor" href="#_使用_rootless_模式运行_server实验性"></a>使用 Rootless 模式运行 Server（实验性）</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>警告</strong>：此功能是实验性的。</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Rootless 模式允许非特权用户运行 K3s Server，这样可以保护主机上真正的 root 免受潜在的容器攻击。</p>
</div>
<div class="paragraph">
<p>有关 Rootless 模式 Kubernetes 的更多信息，请参阅<a href="https://rootlesscontaine.rs/">此处</a>。</p>
</div>
<div class="sect2">
<h3 id="_known_issues_with_rootless_mode"><a class="anchor" href="#_known_issues_with_rootless_mode"></a>Rootless 模式的已知问题</h3>
<div class="ulist">
<ul>
<li>
<p><strong>端口</strong></p>
<div class="paragraph">
<p>如果以 Rootless 模式运行，将创建一个新的网络命名空间。换言之，K3s 实例在网络与主机完全分离的情况下运行。
 要从主机访问在 K3s 中运行的 Service，唯一的方法是设置转发到 K3s 网络命名空间的端口。
 Rootless 模式下的 K3s 包含控制器，它会自动将 6443 和低于 1024 的 Service 端口绑定到偏移量为 10000 的主机。</p>
</div>
<div class="paragraph">
<p>例如，端口 80 上的 Service 在主机上会变成 10080，但 8080 会变成 8080，没有任何偏移。目前只有 LoadBalancer Service 是自动绑定的。</p>
</div>
</li>
<li>
<p><strong>Cgroups</strong></p>
<div class="paragraph">
<p>不支持 Cgroup v1 和 Hybrid v1/v2，仅支持纯 Cgroup v2。如果 K3s 在 Rootless 模式下运行时由于缺少 cgroup 而无法启动，很可能你的节点处于 Hybrid 模式，而且"`丢失`"的 cgroup 仍然绑定了 v1 控制器。</p>
</div>
</li>
<li>
<p><strong>多节点/多进程集群</strong></p>
<div class="paragraph">
<p>目前，我们不支持多节点无根集群或同一节点上的多个无根 k3s 进程。有关详细信息，请参阅 <a href="https://github.com/k3s-io/k3s/issues/6488#issuecomment-1314998091">#6488</a>。</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_启动_rootless_server"><a class="anchor" href="#_启动_rootless_server"></a>启动 Rootless Server</h3>
<div class="ulist">
<ul>
<li>
<p>启用 cgroup v2 授权，请参阅 <a href="https://rootlesscontaine.rs/getting-started/common/cgroup2/。" class="bare">https://rootlesscontaine.rs/getting-started/common/cgroup2/。</a>
此步骤是必需的。如果没有正确的 cgroups 授权，rootless kubelet 将无法启动。</p>
</li>
<li>
<p>从 <a href="https://github.com/k3s-io/k3s/blob/main/k3s-rootless.service"><code>https://github.com/k3s-io/k3s/blob/&lt;VERSION&gt;/k3s-rootless.service</code></a> 下载 <code>k3s-rootless.service</code>。
确保使用了相同版本的 <code>k3s-rootless.service</code> 和 <code>k3s</code>。</p>
</li>
<li>
<p>将 <code>k3s-rootless.service</code> 安装到 <code>~/.config/systemd/user/k3s-rootless.service</code>。
不支持将此文件安装为全系统服务 (<code>/etc/systemd/...</code>)。
根据 <code>k3s</code> 二进制文件的路径，你可能需要修改文件的 <code>ExecStart=/usr/local/bin/k3s ...</code> 行。</p>
</li>
<li>
<p>运行 <code>systemctl --user daemon-reload</code></p>
</li>
<li>
<p>运行 <code>systemctl --user enable --now k3s-rootless</code></p>
</li>
<li>
<p>运行 <code>KUBECONFIG=~/.kube/k3s.yaml kubectl get pods -A</code>，并确保 Pod 正在运行。</p>
</li>
</ul>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>注意</strong>：由于终端会话不允许 cgroup v2 授权，因此不要尝试在终端上运行 <code>k3s server --rootless</code>。
如果你确实需要在终端上使用，请使用 <code>systemd-run --user -p Delegate=yes --tty k3s server --rooless</code> 将其包装在 systemd 范围内。</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="_高级无根配置"><a class="anchor" href="#_高级无根配置"></a>高级无根配置</h3>
<div class="paragraph">
<p>Rootless K3s 使用 <a href="https://github.com/rootless-containers/rootlesskit">rootlesskit</a> 和 <a href="https://github.com/rootless-containers/slirp4netns">slirp4netns</a> 在主机和用户网络命名空间之间进行通信。
rootlesskit 和 slirp4nets 使用的一些配置可以通过环境变量来设置。设置它们的最佳方法是将它们添加到 k3s-rootless systemd 单元的 <code>Environment</code> 字段中。</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">变量</th>
<th class="tableblock halign-left valign-top">默认</th>
<th class="tableblock halign-left valign-top">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>K3S_ROOTLESS_MTU</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1500</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">为 slirp4netns 虚拟接口设置 MTU。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>K3S_ROOTLESS_CIDR</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10.41.0.0/16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置 slirp4netns 虚拟接口使用的 CIDR。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>K3S_ROOTLESS_ENABLE_IPV6</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">autotedected</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">启用 slirp4netns IPv6 支持。如果未指定，则在 K3s 配置为双栈时自动启用。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>K3S_ROOTLESS_PORT_DRIVER</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">builtin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">选择无根 port driver，可选值是 <code>builtin</code> 或 <code>slirp4netns</code>。<code>builtin</code> 速度更快，但会伪装入站数据包的原始源地址。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>K3S_ROOTLESS_DISABLE_HOST_LOOPBACK</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">控制是否允许通过网关接口访问主机的环回地址。出于安全原因，建议不要更改此设置。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_rootless_模式故障排除"><a class="anchor" href="#_rootless_模式故障排除"></a>Rootless 模式故障排除</h3>
<div class="ulist">
<ul>
<li>
<p>运行 <code>systemctl --user status k3s-rootless</code> 来检查 daemon 状态</p>
</li>
<li>
<p>运行 <code>journalctl --user -f -u k3s-rootless</code> 来查看​​ daemon 日志</p>
</li>
<li>
<p>另见 <a href="https://rootlesscontaine.rs/" class="bare">https://rootlesscontaine.rs/</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_节点标签和污点"><a class="anchor" href="#_节点标签和污点"></a>节点标签和污点</h2>
<div class="sectionbody">
<div class="paragraph">
<p>K3s Agent 可以通过 <code>--node-label</code> 和 <code>--node-taint</code> 选项来配置，它们会为 kubelet 添加标签和污点。这两个选项仅在<a href="cli/agent.html#_node_labels_and_taints_for_agents" class="xref page">注册时</a>添加标签和/或污点，因此只能在节点首次加入集群时设置。</p>
</div>
<div class="paragraph">
<p>当前所有的 Kubernetes 版本都限制节点注册到带有 <code>kubernetes.io</code> 和 <code>k8s.io</code> 前缀的大部分标签，特别是 <code>kubernetes.io/role</code> 标签。如果你尝试启动带有不允许的标签的节点，K3s 将无法启动。正如 Kubernetes 作者所说：</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>不允许节点断言自己的角色标签。节点角色通常用于识别节点的特权或 control plane 类型，如果允许节点将自己标记到该池，那么受感染的节点将能吸引可授予更高特权凭证访问权限的工作负载（如 control plane 守护进程）。</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>有关详细信息，请参阅 <a href="https://github.com/kubernetes/enhancements/blob/master/keps/sig-auth/279-limit-node-access/README.md#proposal">SIG-Auth KEP 279</a>。</p>
</div>
<div class="paragraph">
<p>如果你想在节点注册后更改节点标签和污点，或者添加保留标签，请使用 <code>kubectl</code>。关于如何添加<a href="https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/">污点</a>和<a href="https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#add-a-label-to-a-node">节点标签</a>的详细信息，请参阅官方 Kubernetes 文档。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_使用安装脚本启动服务"><a class="anchor" href="#_使用安装脚本启动服务"></a>使用安装脚本启动服务</h2>
<div class="sectionbody">
<div class="paragraph">
<p>安装脚本将自动检测你的操作系统使用的是 systemd 还是 openrc，并在安装过程中启动该服务。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>使用 openrc 运行时，将在 <code>/var/log/k3s.log</code> 中创建日志。</p>
</li>
<li>
<p>使用 systemd 运行时，将在 <code>/var/log/syslog</code> 中创建日志，你可以通过 <code>journalctl -u k3s</code>（Agent 上是 <code>journalctl -u k3s-agent</code>）查看日志。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>使用安装脚本禁用自动启动和服务启用的示例：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -sfL https://get.k3s.io | INSTALL_K3S_SKIP_START=true INSTALL_K3S_SKIP_ENABLE=true sh -</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_其他操作系统准备"><a class="anchor" href="#_其他操作系统准备"></a>其他操作系统准备</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_旧的_iptables_版本"><a class="anchor" href="#_旧的_iptables_版本"></a>旧的 iptables 版本</h3>
<div class="paragraph">
<p>几个主流 Linux 发行版发布的 iptables 版本包含一个错误，该错误会导致重复规则的累积，从而对节点的性能和稳定性产生负面影响。有关如何确定你是否受此问题影响，请参阅 <a href="https://github.com/k3s-io/k3s/issues/3117">issue #3117</a>。</p>
</div>
<div class="paragraph">
<p>K3s 具有一个可以正常运行的 iptables (v1.8.8) 版本。你可以通过使用 <code>--prefer-bundled-bin</code> 选项来启动 K3s，或从操作系统中卸载 iptables/nftables 包，从而让 K3s 使用捆绑的 iptables 版本。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">版本</div>
<div class="paragraph">
<p><code>--prefer-bundled-bin</code> 标志从 2022-12 版本开始可用（v1.26.0+k3s1、v1.25.5+k3s1、v1.24.9+k3s1、v1.23.15+k3s1）。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_red_hat_enterprise_linux_centos"><a class="anchor" href="#_red_hat_enterprise_linux_centos"></a>Red Hat Enterprise Linux / CentOS</h3>
<div class="paragraph">
<p>建议关闭 firewalld：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">systemctl disable firewalld --now</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果要保持启用 firewalld，默认情况下需要以下规则：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">firewall-cmd --permanent --add-port=6443/tcp #apiserver
firewall-cmd --permanent --zone=trusted --add-source=10.42.0.0/16 #pods
firewall-cmd --permanent --zone=trusted --add-source=10.43.0.0/16 #services
firewall-cmd --reload</code></pre>
</div>
</div>
<div class="paragraph">
<p>你可能还需要打开其他端口。有关详细信息，请参阅<a href="installation/requirements.html#_inbound_rules_for_k3s_nodes" class="xref page">入站规则</a>。如果更改了 pod 或服务的默认 CIDR，则需要相应地更新防火墙规则。</p>
</div>
<div class="paragraph">
<p>如果启用，则需要禁用 nm-cloud-setup 并重新启动节点：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">systemctl disable nm-cloud-setup.service nm-cloud-setup.timer
reboot</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ubuntu"><a class="anchor" href="#_ubuntu"></a>Ubuntu</h3>
<div class="paragraph">
<p>建议关闭 ufw（不复杂的防火墙）：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ufw disable</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果要保持启用 ufw，默认情况下需要以下规则：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ufw allow 6443/tcp #apiserver
ufw allow from 10.42.0.0/16 to any #pods
ufw allow from 10.43.0.0/16 to any #services</code></pre>
</div>
</div>
<div class="paragraph">
<p>你可能还需要打开其他端口。有关详细信息，请参阅<a href="installation/requirements.html#_inbound_rules_for_k3s_nodes" class="xref page">入站规则</a>。如果更改了 pod 或服务的默认 CIDR，则需要相应地更新防火墙规则。</p>
</div>
</div>
<div class="sect2">
<h3 id="_raspberry_pi"><a class="anchor" href="#_raspberry_pi"></a>Raspberry Pi</h3>
<div class="paragraph">
<p>Raspberry Pi OS 基于 Debian，可能会受到旧 iptables 版本的影响。请参阅<a href="#_旧的_iptables_版本">解决方法</a>。
旧的 iptables 版本</p>
</div>
<div class="paragraph">
<p>标准 Raspberry Pi OS 不会在启用 <code>cgroups</code> 的情况下开始。<strong>K3S</strong> 需要 <code>cgroups</code> 来启动 systemd 服务。你可以通过将 <code>cgroup_memory=1 cgroup_enable=memory</code> 附加到 <code>/boot/cmdline.txt</code> 来启用 <code>cgroups</code> 。</p>
</div>
<div class="paragraph">
<p>示例 cmdline.txt：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>console=serial0,115200 console=tty1 root=PARTUUID=58b06195-02 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait cgroup_memory=1 cgroup_enable=memory</pre>
</div>
</div>
<div class="paragraph">
<p>从 Ubuntu 21.10 开始，对 Raspberry Pi 的 vxlan 支持已移至单独的内核模块中。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo apt install linux-modules-extra-raspi</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_k3s_in_docker"><a class="anchor" href="#_running_k3s_in_docker"></a>在 Docker 中运行 K3s</h2>
<div class="sectionbody">
<div class="paragraph">
<p>在 Docker 中运行 K3s 有几种方法：</p>
</div>
<div id="_tabs_1" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="_tabs_1_k3d" class="tab">
<p>K3d</p>
</li>
<li id="_tabs_1_docker" class="tab">
<p>Docker</p>
</li>
</ul>
</div>
<div id="_tabs_1_k3d--panel" class="tabpanel" aria-labelledby="_tabs_1_k3d">
<div class="paragraph">
<p><a href="https://github.com/k3d-io/k3d">k3d</a> 是一个用于在 Docker 中轻松运行多节点 K3s 集群的实用程序。</p>
</div>
<div class="paragraph">
<p>K3d 能让你轻松在 Docker 中&gt;创建单节点和多节点 K3s 集群（例如 Kubernetes 上的本地开发）。</p>
</div>
<div class="paragraph">
<p>有关如何安装和使用 K3d 的更多信息，请参阅<a href="https://k3d.io/#installation">安装</a>文档。</p>
</div>
</div>
<div id="_tabs_1_docker--panel" class="tabpanel" aria-labelledby="_tabs_1_docker">
<div class="paragraph">
<p>要使用 Docker，你还可以使用 <code>rancher/k3s</code> 镜像来运行 K3s Server 和 Agent。
使用 <code>docker run</code> 命令：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo docker run \
  --privileged \
  --name k3s-server-1 \
  --hostname k3s-server-1 \
  -p 6443:6443 \
  -d rancher/k3s:v1.24.10-k3s1 \
  server</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>你必须指定一个有效的 K3s 版本作为标签；我们未维护 <code>latest</code> 标签。 Docker 镜像不支持在标签中使用 <code>+</code> 符号，因此，请在标签中使用 <code>-</code> 符号。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>K3s 运行后，你可以将 admin kubeconfig 从 Docker 容器中复制出来：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo docker cp k3s-server-1:/etc/rancher/k3s/k3s.yaml ~/.kube/config</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_selinux_support"><a class="anchor" href="#_selinux_support"></a>SELinux 支持</h2>
<div class="sectionbody">
<div class="paragraph">
<p>如果你在默认启用 SELinux 的系统（例如 CentOS）上安装 K3s，则必须确保已安装正确的 SELinux 策略。</p>
</div>
<div id="_tabs_2" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="_tabs_2_自动安装" class="tab">
<p>自动安装</p>
</li>
<li id="_tabs_2_手动安装" class="tab">
<p>手动安装</p>
</li>
</ul>
</div>
<div id="_tabs_2_自动安装--panel" class="tabpanel" aria-labelledby="_tabs_2_自动安装">
<div class="paragraph">
<p>如果系统兼容，而且没有进行离线安装，那么<a href="installation/configuration.html#_configuration_with_install_script" class="xref page">安装脚本</a>将自动从 Rancher RPM 仓库安装 SELinux RPM。你通过设置 <code>INSTALL_K3S_SKIP_SELINUX_RPM=true</code> 来跳过自动安装。</p>
</div>
</div>
<div id="_tabs_2_手动安装--panel" class="tabpanel" aria-labelledby="_tabs_2_手动安装">
<div class="paragraph">
<p>可以使用以下命令安装必要的策略：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">yum install -y container-selinux selinux-policy-base
yum install -y https://rpm.rancher.io/k3s/latest/common/centos/7/noarch/k3s-selinux-0.2-1.el7_8.noarch.rpm</code></pre>
</div>
</div>
<div class="paragraph">
<p>要让安装脚本报告 warning 而不是 fail，你可以设置环境变量 <code>INSTALL_K3S_SELINUX_WARN=true</code>。</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_启用_selinux_强制执行"><a class="anchor" href="#_启用_selinux_强制执行"></a>启用 SELinux 强制执行</h3>
<div class="paragraph">
<p>要利用 SELinux，请在启动 K3s Server 和 Agent 时指定 <code>--selinux</code> 标志。</p>
</div>
<div class="paragraph">
<p>你也可以在 K3s <a href="installation/configuration.html#_configuration_file" class="xref page">配置文件</a>中指定此选项。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>selinux: true</pre>
</div>
</div>
<div class="paragraph">
<p>不支持在 SELinux 下使用自定义 <code>--data-dir</code>。要自定义它，你可能需要自行编写自定义策略。如需指导，你可以参考 <a href="https://github.com/containers/container-selinux">containers/container-selinux</a> 仓库，仓库包含 Container Runtime 的 SELinux 策略文件，同时你可以参考 <a href="https://github.com/k3s-io/k3s-selinux">k3s-io/k3s-selinux</a> 仓库，该仓库包含 K3s 的 SELinux 策略。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_启用_estargz_的_lazy_pulling实验性"><a class="anchor" href="#_启用_estargz_的_lazy_pulling实验性"></a>启用 eStargz 的 Lazy Pulling（实验性）</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_什么是_lazy_pulling_和_estargz"><a class="anchor" href="#_什么是_lazy_pulling_和_estargz"></a>什么是 Lazy Pulling 和 eStargz？</h3>
<div class="paragraph">
<p>拉取镜像是容器生命周期中比较耗时的步骤之一
（根据 <a href="https://www.usenix.org/conference/fast16/technical-sessions/presentation/harter">Harter 等人</a>的说法）。</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>拉包占容器启动时间的 76%，但却只读取了 6.4% 的数据。</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>为了解决这个问题，K3s 的实验功能支持镜像内容的 <em>lazy pulling</em>。
这允许 K3s 在拉取整个镜像之前启动一个容器。
必要的内容块（例如单个文件）是按需获取的。
对于大镜像而言，这种技术可以缩短容器启动延迟。</p>
</div>
<div class="paragraph">
<p>要启用 lazy pulling，你需要将目标镜像格式化为 <a href="https://github.com/containerd/stargz-snapshotter/blob/main/docs/stargz-estargz.md"><em>eStargz</em></a>。
这是 OCI 的一个替代品，但它 100% OCI 兼容镜像格式，用于 Lazy Pulling。
由于兼容性，eStargz 可以推送到标准容器镜像仓库（例如 ghcr.io），并且即使在 eStargz-agnostic 运行时也<em>仍然可以运行</em>。</p>
</div>
<div class="paragraph">
<p>eStargz 是基于 <a href="https://github.com/google/crfs">Google CRFS 项目提出的 stargz 格式</a>开发的，具有内容验证和性能优化等实用功能。
有关 Lazy Pulling 和 eStargz 的更多信息，请参阅 <a href="https://github.com/containerd/stargz-snapshotter">Stargz Snapshotter 项目仓库</a>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_配置_k3s_进行_estargz_的_lazy_pulling"><a class="anchor" href="#_配置_k3s_进行_estargz_的_lazy_pulling"></a>配置 K3s 进行 eStargz 的 Lazy Pulling</h3>
<div class="paragraph">
<p>如下所示，K3s Server 和 Agent 需要 <code>--snapshotter=stargz</code> 选项。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">k3s server --snapshotter=stargz</code></pre>
</div>
</div>
<div class="paragraph">
<p>使用此配置，你可以对 eStargz 格式的镜像进行 Lazy Pulling。
以下 Pod 清单示例使用 eStargz 格式的 <code>node:13.13.0</code> 镜像 (<code>ghcr.io/stargz-containers/node:13.13.0-esgz</code>)。
当启用 stargz snapshotter 时，K3s 会对该镜像进行 lazy pulling。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Pod
metadata:
  name: nodejs
spec:
  containers:
  - name: nodejs-estargz
    image: ghcr.io/stargz-containers/node:13.13.0-esgz
    command: ["node"]
    args:
    - -e
    - var http = require('http');
      http.createServer(function(req, res) {
        res.writeHead(200);
        res.end('Hello World!\n');
      }).listen(80);
    ports:
    - containerPort: 80</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_additional_logging_sources"><a class="anchor" href="#_additional_logging_sources"></a>其他日志来源</h2>
<div class="sectionbody">
<div class="paragraph">
<p>你可以在不使用 Rancher 的情况下为 K3s 安装 <a href="https://documentation.suse.com/cloudnative/rancher-manager/latest/en/observability/logging/logging-helm-chart-options.html">Rancher Logging</a>。为此，你可以执行以下命令：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm repo add rancher-charts https://charts.rancher.io
helm repo update
helm install --create-namespace -n cattle-logging-system rancher-logging-crd rancher-charts/rancher-logging-crd
helm install --create-namespace -n cattle-logging-system rancher-logging --set additionalLoggingSources.k3s.enabled=true rancher-charts/rancher-logging</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_其他网络策略日志"><a class="anchor" href="#_其他网络策略日志"></a>其他网络策略日志</h2>
<div class="sectionbody">
<div class="paragraph">
<p>支持记录网络策略丢弃的数据包。数据包被发送到 iptables NFLOG 操作，它显示了数据包的详细信息，包括阻止它的网络策略。</p>
</div>
<div class="paragraph">
<p>如果流量很大，日志消息的数量可能会非常多。要在每个策略上控制日志速率，你可以在 question 的网络策略中添加以下注释，从而设置 <code>limit</code> 和 <code>limit-burst</code> iptables 参数：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>kube-router.io/netpol-nflog-limit=&lt;LIMIT-VALUE&gt;</code></p>
</li>
<li>
<p><code>kube-router.io/netpol-nflog-limit-burst=&lt;LIMIT-BURST-VALUE&gt;</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>默认值为 <code>limit=10/minute</code> 和 <code>limit-burst=10</code>。你可以查看 <a href="https://www.netfilter.org/documentation/HOWTO/packet-filtering-HOWTO-7.html#:~:text=restrict%20the%20rate%20of%20matches">iptables 手册</a>以进一步了解这些字段的格式和可选值。</p>
</div>
<div class="paragraph">
<p>要将 NFLOG 数据包转换为日志条目，请安装 ulogd2 并将 <code>[log1]</code> 配置为在 <code>group=100</code> 上读取。然后，重启 ulogd2 服务以提交新配置。
当数据包被网络策略规则阻止时，日志消息将出现在 <code>/var/log/ulog/syslogemu.log</code> 中。</p>
</div>
<div class="paragraph">
<p>发送到 NFLOG netlink 套接字的数据包也可以使用 tcpdump 或 tshark 等命令行工具读取：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tcpdump -ni nflog:100</code></pre>
</div>
</div>
<div class="paragraph">
<p>虽然更容易获得，但 tcpdump 不会显示阻止数据包的网络策略的名称。你可以使用 wireshark 的 tshark 命令来显示完整的 NFLOG 数据包标头，其中包括包含了策略名称的 <code>nflog.prefix</code> 字段。</p>
</div>
<div class="paragraph">
<p>Network Policy logging of dropped packets does not support <a href="https://github.com/k3s-io/k3s/issues/8008">policies with an empty <code>podSelector</code></a>. If you rely on logging dropped packets for diagnostic or audit purposes, ensure that your policies include a pod selector that matches the affected pods.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="networking/networking-services.html">网络</a></span>
  <span class="next"><a href="reference/env-variables.html">环境变量</a></span>
</nav>
</article>
  </div>
</main>
</div>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/vendor/lunr-languages.js"></script>
<script src="../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../.." data-snippet-length="100" data-stylesheet="../../../_/css/search.css"></script>
<script async src="../../../search-index.js"></script>
<script src="../../../_/js/vendor/langSelection.js"></script>
<script async src="../../../_/js/vendor/tabs.js"></script>


<script src="../../../_/js/CNLanguageSwitcher.js"></script>
  </body>
</html>
